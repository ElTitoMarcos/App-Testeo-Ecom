<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Product Research Copilot</title>
<link rel="stylesheet" href="/static/css/app.css">
<link rel="stylesheet" href="/static/css/toast.css">
<style>
/* Basic layout */
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, sans-serif; color:#222; background: linear-gradient(to bottom, #f8fbff, #e9f0ff); }
body.dark { background: #1a1b2e; color:#eaeaea; }
header { padding:20px; text-align:center; background: linear-gradient(90deg, #0062ff, #00c8ff); color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
body.dark header { background: linear-gradient(90deg, #2e2e78, #6547a6); }
.container { max-width: 1200px; margin: 0 auto; padding: 10px; }
.card { background:#fff; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); padding:15px; margin-bottom:15px; }
body.dark .card { background:#262a51; box-shadow:0 0 10px rgba(0,0,0,0.4); }
/* Controls */
#controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
button { padding:8px 14px; border:none; border-radius:4px; cursor:pointer; background: linear-gradient(90deg,#0062ff,#00c8ff); color:#fff; font-weight:600; box-shadow:0 3px 5px rgba(0,0,0,0.2); transition:opacity 0.2s; }
button:hover { opacity:0.85; }
body.dark button { background: linear-gradient(90deg,#3a3cad,#7a53d6); color:#fff; }
/* Chip style for filter toggle */
#btnFilters { background:#e0f0ff; border:1px solid #0077cc; color:#0077cc; padding:6px 10px; border-radius:16px; font-size:14px; }
body.dark #btnFilters { background:#2a2d5c; border-color:#7a53d6; color:#a9a9ff; }
select, input[type="text"], input[type="password"] { padding:6px; border-radius:4px; border:1px solid #ccc; }
body.dark select, body.dark input[type="text"], body.dark input[type="password"] { background:#1f2344; color:#eaeaea; border-color:#444; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; border:1px solid #ccc; }
body.dark th, body.dark td { border-color:#444; }
tbody tr:nth-child(even) { background:#f2f6ff; }
body.dark tbody tr:nth-child(even) { background:#2a2d5c; }
body.dark tbody tr:nth-child(odd) { background:#25285a; }
tbody tr:hover {
  box-shadow: 0 0 6px rgba(0,0,0,0.2);
  transform: translateY(-2px);
  transition: box-shadow 0.2s, transform 0.2s;
}
/* History & Details */
#history details { margin-bottom:8px; }
details summary { cursor:pointer; font-weight:600; color:#0062ff; }
body.dark details summary { color:#80b3ff; }
pre { white-space:pre-wrap; background:#f5f7ff; padding:8px; border-radius:4px; }
body.dark pre { background:#2e315f; }
/* Analysis drawer */
.tab-section { white-space:pre-wrap; font-family:monospace; }
/* Weight slider styling */
.weight-slider {
  width:120px;
  accent-color:#0077cc;
}
body.dark .weight-slider {
  accent-color:#7a53d6;
}
/* Info box */
#scoreInfo { display:none; }
body.dark #scoreInfo { background:#262a51; }
</style>
</head>
<body>
<div id="topBar">
  <header style="padding:8px 15px; display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:8px;">
      <h1 style="margin:0; font-size:1.4rem;">Ecom Testing App</h1>
      <p style="margin:0;font-size:12px; opacity:0.8;">By El Tito ü§ô</p>
    </div>
    <div style="flex:1; display:flex; justify-content:flex-end; gap:8px; align-items:center;">
      <input type="file" id="fileInput" style="display:none;" />
      <button id="uploadBtn" title="Subir archivo">üì§</button>
      <button id="refreshBtn" title="Actualizar lista">üîÑ</button>
      <button id="trendsBtn" title="Ver tendencias">üìä</button>
      <button id="darkToggle" title="Modo oscuro">üåô</button>
      <button id="configBtn" title="Configuraci√≥n avanzada">‚öôÔ∏è</button>
    </div>
  </header>
  <!-- Search bar row -->
  <div id="searchRow" style="display:flex; justify-content:center; padding:8px 15px; gap:8px;">
    <input type="text" id="searchInput" placeholder="Buscar producto o palabra clave..." style="flex:1; max-width:600px; padding:8px; border-radius:20px; border:1px solid #ccc; font-size:14px;" />
    <button id="searchBtn">Buscar</button>
  </div>
</div>
<!-- Groups/Lists management -->
<div id="listsSection" class="card" style="margin-top:5px; padding:10px; max-width:420px;">
  <strong>Grupos:</strong>
  <div id="listsContainer" style="margin:6px 0; display:flex; flex-wrap:wrap; gap:6px;"></div>
  <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
    <input type="text" id="newListName" placeholder="Nombre del grupo" style="flex:1; padding:4px; min-width:120px;">
    <button id="createListBtn">Crear</button>
  </div>
</div>
<div id="config" style="display:none;">
  <label>API Key: <input type="password" id="apiKey" /></label>
  <button id="toggleApiKey" style="display:none;">Cambiar API Key</button>
  <label>Modelo:
    <select id="modelSelect">
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4">GPT-4</option>
      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
    </select>
  </label>
  <!-- Pesos para ajustar el c√°lculo del score -->
  <div id="weights" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:12px;">
    <div style="display:flex; flex-direction:column;">
      <label>Momentum</label>
      <input type="range" id="w_momentum" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_momentum" style="font-size:12px; text-align:center;">1.0</span>
    </div>
    <div style="display:flex; flex-direction:column;">
      <label>Saturaci√≥n</label>
      <input type="range" id="w_saturation" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_saturation" style="font-size:12px; text-align:center;">1.0</span>
    </div>
    <div style="display:flex; flex-direction:column;">
      <label>Diferenciaci√≥n</label>
      <input type="range" id="w_differentiation" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_differentiation" style="font-size:12px; text-align:center;">1.0</span>
    </div>
    <div style="display:flex; flex-direction:column;">
      <label>Prueba Social</label>
      <input type="range" id="w_social_proof" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_social_proof" style="font-size:12px; text-align:center;">1.0</span>
    </div>
    <div style="display:flex; flex-direction:column;">
      <label>Margen</label>
      <input type="range" id="w_margin" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_margin" style="font-size:12px; text-align:center;">1.0</span>
    </div>
    <div style="display:flex; flex-direction:column;">
      <label>Log√≠stica</label>
      <input type="range" id="w_logistics" min="0" max="2" step="0.1" value="1" class="weight-slider">
      <span id="val_logistics" style="font-size:12px; text-align:center;">1.0</span>
    </div>
  </div>
  <button id="saveConfig">Guardar configuraci√≥n</button>
  <button id="autoWeights">Ajustar pesos autom√°ticamente</button>
  <button id="toggleScoreInfo">¬øC√≥mo se calcula el score?</button>
</div>
<div id="scoreInfo" class="card">
  <strong>Criterios del score:</strong>
  <ul>
    <li><strong>Momentum</strong>: Evaluaci√≥n de la tendencia de inter√©s/ventas en los √∫ltimos 7, 14 y 30 d√≠as.</li>
    <li><strong>Saturaci√≥n</strong>: N√∫mero de competidores y saturaci√≥n del mercado.</li>
    <li><strong>Diferenciaci√≥n</strong>: Unicidad del producto y √°ngulos de marketing.</li>
    <li><strong>Prueba Social</strong>: Indicadores de aceptaci√≥n como rese√±as e interacciones.</li>
    <li><strong>Margen</strong>: Margen de beneficio estimado seg√∫n precio y coste.</li>
    <li><strong>Log√≠stica</strong>: Complejidad log√≠stica (peso, fragilidad, variantes, env√≠o).</li>
  </ul>
  <p>El <em>total score</em> se calcula como una media ponderada de los seis criterios. A continuaci√≥n se muestran valores y rangos sugeridos para cada peso (puedes ajustarlos manualmente):</p>
  <p><em>¬øQu√© sucede al ajustar los pesos?</em> Aumentar un peso (por ejemplo de 1.0 a 1.5) hace que ese criterio tenga m√°s influencia en el score final. Disminuirlo (por ejemplo de 1.0 a 0.5) reduce su importancia. Valores muy bajos (cercanos a 0) pr√°cticamente eliminan la influencia del criterio, mientras que valores altos (>1.5) lo priorizan mucho sobre los dem√°s.</p>
  <ul>
    <li>Momentum: valor por defecto 1.0 (rango recomendado 0.5‚Äì1.5)</li>
    <li>Saturaci√≥n: valor por defecto 1.0 (rango recomendado 0.5‚Äì1.5)</li>
    <li>Diferenciaci√≥n: valor por defecto 1.0 (rango recomendado 1.0‚Äì2.0)</li>
    <li>Prueba Social: valor por defecto 1.0 (rango recomendado 0.5‚Äì1.5)</li>
    <li>Margen: valor por defecto 1.0 (rango recomendado 1.0‚Äì2.0)</li>
    <li>Log√≠stica: valor por defecto 1.0 (rango recomendado 0.5‚Äì1.0)</li>
  </ul>
  <p>Puedes hacer clic en ‚ÄúAjustar pesos autom√°ticamente‚Äù para que el sistema determine pesos basados en los datos de tus productos evaluados.</p>
</div>
<div id="custom">
  <textarea id="customPrompt" rows="3" placeholder="Escribe tu consulta personalizada a GPT"></textarea><br/>
  <button id="sendPrompt">Enviar consulta a GPT</button>
  <div id="history" style="margin-top:10px;"></div>
</div>
<div id="trends" class="card" style="display:none;"></div>
<!-- Chart container for simple bar graph of top products -->
<div id="chartContainer" class="card" style="display:none;">
  <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:space-around;">
    <div style="flex:1; min-width:300px; text-align:center;">
      <h3 style="margin-bottom:4px; font-size:14px;">Ingresos vs Unidades</h3>
      <canvas id="chartCanvas" width="400" height="250"></canvas>
    </div>
    <div style="flex:1; min-width:300px; text-align:center;">
      <h3 style="margin-bottom:4px; font-size:14px;"># Productos por categor√≠a</h3>
      <canvas id="catCountCanvas" width="400" height="250"></canvas>
    </div>
    <div style="flex:1; min-width:300px; text-align:center;">
      <h3 style="margin-bottom:4px; font-size:14px;">Ingresos medios por categor√≠a</h3>
      <canvas id="catRevenueCanvas" width="400" height="250"></canvas>
    </div>
  </div>
</div>

<!-- Analysis drawer with tabbed content -->
<div id="analysisDrawer" class="drawer right hidden">
  <div style="text-align:right;"><button id="closeAnalysis" style="background:none;border:none;font-size:20px;cursor:pointer;">‚úñ</button></div>
  <div id="analysisContent" style="white-space:pre-wrap; overflow-y:auto; max-height:80vh;"></div>
  <button id="analysisExport">Exportar</button>
</div>
<div id="table-toolbar" class="table-toolbar">
  <div style="display:flex; align-items:center; gap:8px;">
    <input type="checkbox" id="selectAll">
    <button id="btnFilters">Filtros</button>
    <div id="activeFilterChips" style="display:flex; flex-wrap:wrap;"></div>
    <div>
      <select id="groupSelect"></select>
      <button id="btnAddToGroup">A√±adir</button>
    </div>
  </div>
  <div id="listMeta">0 resultados ‚Ä¢ Vista: Tabla ‚ñæ</div>
  <div>
    <button id="btnDelete" disabled>Eliminar</button>
    <button id="btnExport" disabled>Exportar</button>
  </div>
</div>

<table id="productTable">
  <thead class="sticky-thead">
    <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>
<button id="legendBtn" class="legend-btn">‚ÑπÔ∏è</button>
<div id="legendPop" class="popover hidden">
  <div>‚Ä¢ Fila roja: duplicado</div>
  <div>‚Ä¢ üî• x1‚Äìx5: tendencia en el nombre</div>
</div>

<!-- Overlay for viewing images in larger size -->
<div id="imgOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
  <img id="overlayImg" src="" style="max-width:90%; max-height:90%; box-shadow:0 0 10px #000; border-radius:8px;" />
</div>
<!-- Progress bar for micro interactions -->
<div id="progressBar" style="position:fixed; top:0; left:0; height:3px; background:#0077cc; width:0%; display:none; z-index:3000;"></div>
<!-- Loading overlay shown during file uploads -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); color:#fff; font-size:20px; align-items:center; justify-content:center; z-index:2000;">
  <div style="text-align:center;">
    <div class="spinner" style="margin-bottom:10px; width:40px; height:40px; border:5px solid #f3f3f3; border-top:5px solid #0062ff; border-radius:50%; animation: spin 1s linear infinite;"></div>
    <div>Cargando archivo...</div>
  </div>
</div>
<div id="filtersDrawer" class="drawer right hidden">
  <h3>Filtros</h3>
  <div style="display:flex; flex-direction:column; gap:8px;">
    <label>Precio m√≠n<br><input type="number" id="filterPriceMin"></label>
    <label>Precio m√°x<br><input type="number" id="filterPriceMax"></label>
    <label>Fecha desde<br><input type="date" id="filterDateMin"></label>
    <label>Fecha hasta<br><input type="date" id="filterDateMax"></label>
    <label>Rating m√≠n<br><input type="number" id="filterRatingMin" step="0.1" min="0" max="5"></label>
    <label>Categor√≠a<br><input type="text" id="filterCategory"></label>
    <label>Score m√≠n<br><input type="number" id="filterScoreMin" step="0.1"></label>
  </div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button id="applyFilters" style="flex:1;">Aplicar</button>
    <button id="clearFilters" style="flex:1;">Limpiar</button>
  </div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script src="/static/js/toast.js"></script>
<script src="/static/js/table.js"></script>
<script type="module">
import { fetchJson } from "/static/js/net.js";
import { openAnalysis } from "/static/js/analyze.js";
window.addEventListener('beforeunload', () => navigator.sendBeacon('/shutdown'));
// Global arrays to hold all products and the current filtered list
let allProducts = [];
let products = [];
let sortField = null;
let sortDir = 1;
const columns = [
  { key: 'id', label: 'ID', type: 'number' },
  { key: 'image_url', label: 'Imagen', type: 'image' },
  { key: 'name', label: 'Nombre', type: 'string' },
  { key: 'category', label: 'Categor√≠a', type: 'string' },
  { key: 'price', label: 'Precio', type: 'number' },
  { key: 'Product Rating', label: 'Rating', type: 'number' },
  { key: 'Item Sold', label: 'Unidades Vendidas', type: 'number' },
  { key: 'Revenue($)', label: 'Ingresos', type: 'number' },
  { key: 'Creator Conversion Ratio', label: 'Tasa Conversi√≥n', type: 'string' },
  { key: 'Launch Date', label: 'Fecha Lanzamiento', type: 'string' },
  { key: 'Date Range', label: 'Rango Fechas', type: 'string' },
  { key: 'score', label: 'Score', type: 'number' },
];

let trendingWords = [];

// Microinteraction progress bar
function startProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.display = 'block';
  bar.style.width = '0%';
  let progress = 0;
  const interval = setInterval(() => {
    progress += 10;
    bar.style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        bar.style.display = 'none';
        bar.style.width = '0%';
      }, 200);
    }
  }, 30);
}

// helper to highlight trending keywords
function isTrending(name) {
  if (!name) return false;
  const words = name.toLowerCase().split(/[^a-z0-9√°√©√≠√≥√∫√º√±]+/);
  return words.some(w => trendingWords.includes(w));
}

async function fetchProducts() {
  const data = await fetchJson('/products');
  // keep a copy of all products for filtering
  allProducts = data;
  products = [...allProducts];
  renderTable();
}

function renderTable() {
  const headerRow = document.getElementById('headerRow');
  const tbody = document.querySelector('#productTable tbody');
  // Build header if empty
  if (!headerRow.hasChildNodes()) {
    // Add select column header (no label)
    const thSel = document.createElement('th');
    headerRow.appendChild(thSel);
    // Add dynamic columns
    columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col.label;
      th.style.cursor = 'pointer';
      th.setAttribute('data-key', col.key);
      th.onclick = () => sortBy(col.key, col.type);
      headerRow.appendChild(th);
    });
      // Analysis column header
      const thAnal = document.createElement('th');
      thAnal.textContent = 'üîç';
      headerRow.appendChild(thAnal);
      // Add delete column header
      const thDel = document.createElement('th');
      headerRow.appendChild(thDel);
  }
  // Clear body
  tbody.innerHTML = '';
  // Render rows
    products.forEach(item => {
    const tr = document.createElement('tr');
    // mark duplicate rows
    if (item.extras && item.extras['duplicate_of']) {
      tr.style.backgroundColor = 'rgba(255, 230, 230, 0.5)';
    }
    // trending highlighting is now indicated by fire emojis instead of row outline
    // Selection checkbox
    const tdSel = document.createElement('td');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.classList.add('rowCheck');
    cb.dataset.id = item.id;
    cb.checked = selection.has(item.id);
    tr.classList.toggle('selected', cb.checked);
    cb.addEventListener('change', () => {
      if (cb.checked) selection.add(item.id); else selection.delete(item.id);
      tr.classList.toggle('selected', cb.checked);
      updateMasterState();
    });
    tdSel.appendChild(cb);
    tr.appendChild(tdSel);
    columns.forEach(col => {
      const td = document.createElement('td');
      const key = col.key;
      let value = '';
      if (['id','name','category','price','image_url','score'].includes(key)) {
        value = item[key];
      } else {
        value = item.extras ? item.extras[key] : '';
      }
      if (key === 'score') {
        const sc = parseFloat(value);
        if (!isNaN(sc)) {
          td.innerHTML = '<span class="' + scoreClass(sc) + '">' + Math.round(sc) + '</span>';
        }
      } else if (key === 'image_url' && value) {
        const img = document.createElement('img');
        img.src = value;
        // Increase the preview size for better visibility
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        // Show larger image on click
        img.style.cursor = 'pointer';
        img.onclick = () => {
          showOverlay(value);
        };
        td.appendChild(img);
      } else if (key === 'name' && value) {
        const fireText = firesFor(item.trendingScore);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = value + (fireText ? ' ' : '');
        td.appendChild(nameSpan);
        if (fireText) {
          const fireSpan = document.createElement('span');
          fireSpan.className = 'fires';
          fireSpan.textContent = fireText;
          td.appendChild(fireSpan);
        }
        // If Kalodata URL exists, add copy link button
        const kal = item.extras && item.extras['KalodataUrl'];
        if (kal) {
          const btnCopy = document.createElement('button');
          btnCopy.textContent = 'üìã';
          btnCopy.title = 'Copiar link Kalodata';
          btnCopy.style.marginLeft = '5px';
          btnCopy.style.padding = '2px 6px';
          btnCopy.style.fontSize = '12px';
          btnCopy.onclick = () => {
            navigator.clipboard.writeText(kal).then(() => {
              toast.success('Link copiado al portapapeles');
            });
          };
          td.appendChild(btnCopy);
        }
      } else if (col.type === 'number' && value !== null && value !== undefined && value !== '') {
        let num = parseFloat(String(value).replace(/[^0-9.-]+/g, ''));
        if (isNaN(num)) {
          td.textContent = '';
        } else {
          if (key === 'Item Sold' || key === 'Revenue($)' || key === 'Creator Number') {
            td.textContent = abbr(num);
          } else {
            td.textContent = num.toLocaleString();
          }
        }
      } else {
        td.textContent = value || '';
      }
      tr.appendChild(td);
    });
    // Analysis button cell
    const tdAnal = document.createElement('td');
    const btnAnal = document.createElement('button');
    btnAnal.textContent = 'üîç';
    btnAnal.title = 'Analizar producto';
    btnAnal.style.background = 'transparent';
    btnAnal.style.border = 'none';
    btnAnal.style.cursor = 'pointer';
    btnAnal.style.fontSize = '16px';
    btnAnal.dataset.id = item.id;
    btnAnal.onclick = () => {
      openAnalysis(item);
    };
    tdAnal.appendChild(btnAnal);
    tr.appendChild(tdAnal);
    // Delete button
    const tdDel = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‚úñ';
    btn.title = 'Eliminar producto';
    btn.style.background = 'transparent';
    btn.style.border = 'none';
    btn.style.cursor = 'pointer';
    btn.style.color = 'red';
    btn.dataset.id = item.id;
    btn.onclick = () => {
      toast.info('¬øEliminar producto?', {actionText:'Eliminar', onAction: () => deleteProduct(item.id)});
    };
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });
  currentPageIds = products.map(p => p.id);
  document.getElementById('listMeta').textContent = `${currentPageIds.length} resultados ‚Ä¢ Vista: Tabla ‚ñæ`;
  updateMasterState();
}

function sortBy(field, type) {
  if (sortField === field) {
    sortDir = -sortDir;
  } else {
    sortField = field;
    sortDir = 1;
  }
  products.sort((a, b) => {
    let va;
    let vb;
    if (field === 'id' || field === 'name' || field === 'category' || field === 'price' || field === 'image_url' || field === 'score') {
      va = a[field];
      vb = b[field];
    } else {
      va = a.extras ? a.extras[field] : undefined;
      vb = b.extras ? b.extras[field] : undefined;
    }
    if (type === 'number') {
      const na = parseFloat(String(va).replace(/[^0-9.-]+/g, ''));
      const nb = parseFloat(String(vb).replace(/[^0-9.-]+/g, ''));
      if (isNaN(na) && isNaN(nb)) return 0;
      if (isNaN(na)) return sortDir * 1;
      if (isNaN(nb)) return sortDir * -1;
      return (na - nb) * sortDir;
    }
    // default string comparison
    const sa = (va || '').toString().toLowerCase();
    const sb = (vb || '').toString().toLowerCase();
    if (sa < sb) return -1 * sortDir;
    if (sa > sb) return 1 * sortDir;
    return 0;
  });
  renderTable();
}

document.getElementById('refreshBtn').onclick = fetchProducts;
window.onload = fetchProducts;
// Toggle config panel
document.getElementById('configBtn').onclick = () => {
  const cfg = document.getElementById('config');
  if (!cfg) return;
  cfg.style.display = (cfg.style.display === 'none' || cfg.style.display === '') ? 'block' : 'none';
};
// Handle file upload: clicking the upload button opens file chooser
const fileInputEl = document.getElementById('fileInput');
document.getElementById('uploadBtn').onclick = () => {
  fileInputEl.click();
};
// When a file is selected, automatically upload it
fileInputEl.onchange = async () => {
  const file = fileInputEl.files[0];
  if(!file) return;
  const formData = new FormData();
  formData.append('file', file);
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.style.opacity = '0.6';
  const loading = document.getElementById('loadingOverlay');
  if (loading) loading.style.display = 'flex';
  try {
    const data = await fetchJson('/upload', {method:'POST', body: formData});
    if(data.error){
      toast.error('Error: '+data.error);
    } else {
      let msg = '';
      if(data.inserted !== undefined) {
        msg += 'Productos importados: '+data.inserted+'\n';
      }
      if(data.uploaded_image){
        if(data.inserted && data.inserted > 0) {
          msg += 'Se proces√≥ la imagen y se a√±adieron productos.';
        } else {
          msg += 'Imagen subida. No se a√±adieron productos autom√°ticamente.';
        }
      }
      toast.success(msg || 'Archivo procesado');
      fetchProducts();
    }
  } catch(err){
    console.error(err);
    toast.error('Error al subir archivo');
  } finally {
    if (loading) loading.style.display = 'none';
    btn.disabled = false;
    btn.style.opacity = '';
    fileInputEl.value = '';
  }
};
document.getElementById('saveConfig').onclick = async () => {
  const apiInput = document.getElementById('apiKey');
  const key = apiInput.style.display === 'none' ? '' : apiInput.value.trim();
  const model = document.getElementById('modelSelect').value;
  const payload = {};
  if(key) payload.api_key = key;
  payload.model = model;
  // collect weights
  const weights = {
    momentum: parseFloat(document.getElementById('w_momentum').value) || 0,
    saturation: parseFloat(document.getElementById('w_saturation').value) || 0,
    differentiation: parseFloat(document.getElementById('w_differentiation').value) || 0,
    social_proof: parseFloat(document.getElementById('w_social_proof').value) || 0,
    margin: parseFloat(document.getElementById('w_margin').value) || 0,
    logistics: parseFloat(document.getElementById('w_logistics').value) || 0,
  };
  payload.weights = weights;
  const data = await fetchJson('/setconfig', {method:'POST', body: JSON.stringify(payload)});
  if(data.error){ toast.error('Error: '+data.error); } else {
    toast.success('Configuraci√≥n guardada');
    // hide API key input if user entered one
    if(key){
      apiInput.value = '';
      apiInput.style.display = 'none';
      document.getElementById('toggleApiKey').style.display = 'inline-block';
    }
  }
};
// auto weights button
document.getElementById('autoWeights').onclick = async () => {
  const data = await fetchJson('/auto_weights', {method:'POST'});
  if (data.error) {
    toast.error('Error al ajustar pesos: ' + data.error);
    return;
  }
  // Update weight inputs
  document.getElementById('w_momentum').value = (data.momentum || 1).toFixed(2);
  document.getElementById('w_saturation').value = (data.saturation || 1).toFixed(2);
  document.getElementById('w_differentiation').value = (data.differentiation || 1).toFixed(2);
  document.getElementById('w_social_proof').value = (data.social_proof || 1).toFixed(2);
  document.getElementById('w_margin').value = (data.margin || 1).toFixed(2);
  document.getElementById('w_logistics').value = (data.logistics || 1).toFixed(2);
  toast.info('Pesos ajustados autom√°ticamente. No olvides guardarlos.');
};

// search feature
document.getElementById('searchBtn').onclick = () => {
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const tbody = document.querySelector('#productTable tbody');
  Array.from(tbody.rows).forEach(row => {
    if (!term) {
      row.style.display = '';
      return;
    }
    const cells = Array.from(row.cells).map(td => td.textContent.toLowerCase());
    const match = cells.some(text => text.includes(term));
    row.style.display = match ? '' : 'none';
  });
};
document.getElementById('sendPrompt').onclick = async () => {
  const prompt = document.getElementById('customPrompt').value.trim();
  if(!prompt){ toast.info('Escribe una consulta'); return; }
  const data = await fetchJson('/custom_gpt', {method:'POST', body: JSON.stringify({prompt: prompt})});
  const history = document.getElementById('history');
  const details = document.createElement('details');
  const summary = document.createElement('summary');
  const shortPrompt = prompt.length > 40 ? prompt.substring(0,37) + '...' : prompt;
  summary.textContent = shortPrompt;
  const pre = document.createElement('pre');
  pre.textContent = data.response || data.error;
  details.appendChild(summary);
  details.appendChild(pre);
  history.prepend(details);
};
document.getElementById('darkToggle').onclick = () => {
  document.body.classList.toggle('dark');
};

// Helper to parse dates from various formats (YYYY-MM-DD or other)
function parseDate(value) {
  if (!value) return null;
  // Try direct Date parse
  const d = new Date(value);
  if (!isNaN(d)) return d;
  // Try splitting by non-digit
  const parts = String(value).match(/(\d{4})[\/-]?(\d{2})[\/-]?(\d{2})/);
  if (parts) {
    const y = parseInt(parts[1]);
    const m = parseInt(parts[2]) - 1;
    const day = parseInt(parts[3]);
    return new Date(y, m, day);
  }
  return null;
}


// toggle API key visibility
document.getElementById('toggleApiKey').onclick = () => {
  const apiInput = document.getElementById('apiKey');
  apiInput.style.display = 'inline-block';
  document.getElementById('toggleApiKey').style.display = 'none';
};

// toggle score info box
document.getElementById('toggleScoreInfo').onclick = () => {
  const box = document.getElementById('scoreInfo');
  box.style.display = box.style.display === 'none' || box.style.display === '' ? 'block' : 'none';
};

// Show overlay with larger image
function showOverlay(src){
  const overlay = document.getElementById('imgOverlay');
  const img = document.getElementById('overlayImg');
  img.src = src;
  overlay.style.display = 'flex';
}
// Hide overlay only when clicking outside the image
document.getElementById('imgOverlay').onclick = (e) => {
  if (e.target.id === 'imgOverlay') {
    document.getElementById('imgOverlay').style.display = 'none';
  }
};

// Setup weight slider labels and colors
['momentum','saturation','differentiation','social_proof','margin','logistics'].forEach(key => {
  const slider = document.getElementById('w_'+key);
  const label = document.getElementById('val_'+key);
  if (slider && label) {
    const update = () => {
      const val = parseFloat(slider.value);
      label.textContent = val.toFixed(1);
      // set gradient color: low (gray) <0.7, mid (yellow) 0.7-1.3, high (green)
      let color;
      if (val < 0.7) color = '#888888';
      else if (val < 1.3) color = '#d4a017';
      else color = '#2c8c28';
      slider.style.background = `linear-gradient(to right, ${color} ${(val/2)*100}%, #ccc ${(val/2)*100}%)`;
    };
    slider.addEventListener('input', update);
    update();
  }
});

// Delete a single product by ID
async function deleteProduct(id){
  try {
    if (typeof currentListId !== 'undefined' && currentListId > 0) {
      // remove only from current list
      const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentListId, ids: [id]})});
      if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); }
      // reload current list
      loadList(currentListId);
    } else {
      const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: [id]})});
      if(data.error){ toast.error('Error al eliminar: '+data.error); }
      fetchProducts();
    }
  } catch(err){ console.error(err); toast.error('Error al eliminar'); }
}

// Delete selected products
document.getElementById('btnDelete').onclick = () => {
  const ids = Array.from(selection);
  if(!ids.length){ toast.info('Selecciona al menos un producto para eliminar'); return; }
  toast.info('¬øEliminar los productos seleccionados?', {actionText:'Eliminar', onAction: async () => {
    try{
      if (typeof currentListId !== 'undefined' && currentListId > 0) {
        const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentListId, ids: ids})});
        if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); } else { toast.success('Eliminados del grupo: '+data.removed); }
        startProgress();
        loadList(currentListId);
      } else {
        const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: ids})});
        if(data.error){ toast.error('Error al eliminar: '+data.error); } else { toast.success('Productos eliminados: '+data.deleted); }
        startProgress();
        fetchProducts();
      }
    }catch(err){ console.error(err); toast.error('Error al eliminar'); }
  }});
};

// Export selected products as CSV
document.getElementById('btnExport').onclick = async () => {
  const ids = Array.from(selection);
  if(!ids.length){ toast.info('Selecciona productos para exportar'); return; }
  // Build query string
  const params = new URLSearchParams();
  params.set('ids', ids.join(','));
  // request export file
  try{
    const res = await fetch('/export?'+params.toString(), {method:'GET'});
    if(res.status !== 200){ toast.error('Error al exportar'); return; }
    const blob = await res.blob();
    // determine filename from header or default
    const disposition = res.headers.get('Content-Disposition');
    let filename = 'export.csv';
    if(disposition){
      const match = disposition.match(/filename="?([^\"]+)"?/);
      if(match) filename = match[1];
    }
    // progress feedback
    startProgress();
    // trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(err){ console.error(err); toast.error('Error al exportar'); }
};

// -------- List management --------
let currentListId = -1; // -1 indicates all products

async function loadLists() {
  try {
    const lists = await fetchJson('/lists');
    const container = document.getElementById('listsContainer');
    const select = document.getElementById('groupSelect');
    container.innerHTML = '';
    select.innerHTML = '';
    // option for no list in assign select
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Selecciona grupo';
    select.appendChild(placeholder);
    // Add a button to view all products
    const allBtn = document.createElement('button');
    allBtn.textContent = 'Todos';
    allBtn.style.padding = '4px 8px';
    allBtn.style.borderRadius = '4px';
    allBtn.style.border = '1px solid #34456B';
    allBtn.style.background = '#1F2A44';
    allBtn.style.color = '#E5EAF5';
    allBtn.style.cursor = 'pointer';
    allBtn.onclick = () => {
      currentListId = -1;
      loadList(-1);
    };
    const allWrapper = document.createElement('span');
    allWrapper.appendChild(allBtn);
    container.appendChild(allWrapper);

    // Add each list
    lists.forEach(lst => {
      // entry in container
      const btn = document.createElement('button');
      btn.textContent = lst.name;
      btn.style.padding = '4px 8px';
      btn.style.borderRadius = '4px';
      btn.style.border = '1px solid #34456B';
      btn.style.background = currentListId === lst.id ? '#33467B' : '#1F2A44';
      btn.style.color = currentListId === lst.id ? '#FFFFFF' : '#E5EAF5';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        currentListId = lst.id;
        loadList(lst.id);
      };
      // delete icon
      const del = document.createElement('span');
      del.textContent = ' ‚úñ';
      del.style.marginLeft = '4px';
      del.style.color = 'red';
      del.style.cursor = 'pointer';
      del.onclick = (ev) => {
        ev.stopPropagation();
        toast.info('¬øEliminar grupo?', {actionText:'Eliminar', onAction: () => deleteList(lst.id)});
      };
      const wrapper = document.createElement('span');
      wrapper.appendChild(btn);
      wrapper.appendChild(del);
      container.appendChild(wrapper);
      // option in select
      const opt = document.createElement('option');
      opt.value = lst.id;
      opt.textContent = lst.name;
      select.appendChild(opt);
    });
  } catch(err) {
    console.error(err);
  }
}

async function deleteList(id){
  try{
    const data = await fetchJson('/delete_list', {method:'POST', body: JSON.stringify({id:id})});
    loadLists();
    if(currentListId === id){
      currentListId = -1;
      fetchProducts();
    }
  }catch(err){ console.error(err); toast.error('Error al eliminar grupo'); }
}

async function loadList(id){
  if(id === -1){
    // load all products
    currentListId = -1;
    fetchProducts();
    // refresh lists to update active styling
    loadLists();
    return;
  }
  try{
    const data = await fetchJson('/list/' + id);
    allProducts = data;
    products = [...allProducts];
    renderTable();
    // refresh lists to highlight active group
    loadLists();
  } catch(err){ console.error(err); toast.error('Error al cargar lista'); }
}

// create list button
document.getElementById('createListBtn').onclick = async () => {
  const name = document.getElementById('newListName').value.trim();
  if(!name){ toast.info('Ingresa un nombre para el grupo'); return; }
  try{
    const data = await fetchJson('/create_list', {method:'POST', body: JSON.stringify({name:name})});
    document.getElementById('newListName').value = '';
    loadLists();
  }catch(err){ console.error(err); toast.error('Error al crear grupo'); }
};

// assign selected products to list
document.getElementById('btnAddToGroup').onclick = async () => {
  const listSelect = document.getElementById('groupSelect');
  const lid = parseInt(listSelect.value);
  if(!lid){ toast.info('Selecciona un grupo'); return; }
  const ids = Array.from(selection);
  if(!ids.length){ toast.info('Selecciona productos para a√±adir'); return; }
  try{
    const data = await fetchJson('/add_to_list', {method:'POST', body: JSON.stringify({id: lid, ids: ids})});
    toast.success('Productos a√±adidos al grupo');
    loadLists();
  }catch(err){ console.error(err); toast.error('Error al a√±adir al grupo'); }
};

// load lists on page load
window.addEventListener('DOMContentLoaded', () => {
  loadLists();
});

// trends button
document.getElementById('trendsBtn').onclick = async () => {
  const cont = document.getElementById('trends');
  // toggle visibility
  if(cont.style.display === 'block'){
    cont.style.display = 'none';
    cont.innerHTML = '';
    // hide and clear charts
    const chartDiv = document.getElementById('chartContainer');
    if(chartDiv) chartDiv.style.display = 'none';
    const canvases = ['chartCanvas','catCountCanvas','catRevenueCanvas'];
    canvases.forEach(id => {
      const cv = document.getElementById(id);
      if(cv){
        const cx = cv.getContext('2d');
        cx && cx.clearRect(0,0,cv.width,cv.height);
      }
    });
    return;
  }
  const data = await fetchJson('/trends');
  if(data.error){
    cont.style.display = 'block';
    cont.textContent = 'Error al cargar tendencias: '+data.error;
    return;
  }
  // store trending keywords for highlighting
  trendingWords = (data.keywords || []).map(([word]) => word.toLowerCase());
  let html = '<h3>Tendencias</h3>';
  if(data.categories && data.categories.length){
    html += '<strong>Categor√≠as m√°s frecuentes:</strong><ul>';
    data.categories.forEach(([cat,count]) => {
      html += `<li>${cat} (${count})</li>`;
    });
    html += '</ul>';
  }
  if(data.keywords && data.keywords.length){
    html += '<strong>Palabras clave destacadas:</strong><ul>';
    data.keywords.forEach(([word,count]) => {
      html += `<li>${word} (${count})</li>`;
    });
    html += '</ul>';
  }
  if(data.top_products && data.top_products.length){
    html += '<strong>Top productos por puntuaci√≥n:</strong><ol>';
    data.top_products.forEach(item => {
      html += `<li>${item.name} (Score: ${item.score.toFixed(2)})</li>`;
    });
    html += '</ol>';
  }
  cont.innerHTML = html;
  cont.style.display = 'block';
  // prepare and draw chart: use existing products array to get revenue and units sold
  const chartDiv = document.getElementById('chartContainer');
  const canvas = document.getElementById('chartCanvas');
  const ctx = canvas.getContext('2d');
  // extract data for top products (limit 10)
  const top = (data.top_products || []).slice(0, 10);
  const labels = [];
  const revenues = [];
  const units = [];
  top.forEach(tp => {
    // find product in local list by id
    const prod = products.find(p => p.id === tp.id);
    if (prod) {
      labels.push(prod.name);
      const rev = prod.extras ? parseFloat(String(prod.extras['Revenue($)']).replace(/[^0-9.-]+/g,'')) : 0;
      const unit = prod.extras ? parseFloat(String(prod.extras['Item Sold']).replace(/[^0-9.-]+/g,'')) : 0;
      revenues.push(isNaN(rev) ? 0 : rev);
      units.push(isNaN(unit) ? 0 : unit);
    }
  });
  // clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (labels.length > 0) {
    // simple bar chart: compute scaling
    const maxRev = Math.max(...revenues);
    const maxUnit = Math.max(...units);
    const barWidth = canvas.width / (labels.length * 2);
    labels.forEach((lbl, idx) => {
      const x = idx * 2 * barWidth + barWidth * 0.5;
      // revenue bar (blue)
      const hRev = maxRev > 0 ? (revenues[idx] / maxRev) * (canvas.height - 40) : 0;
      ctx.fillStyle = '#42a5f5';
      ctx.fillRect(x, canvas.height - hRev - 20, barWidth * 0.4, hRev);
      // units bar (green)
      const hUnit = maxUnit > 0 ? (units[idx] / maxUnit) * (canvas.height - 40) : 0;
      ctx.fillStyle = '#66bb6a';
      ctx.fillRect(x + barWidth * 0.45, canvas.height - hUnit - 20, barWidth * 0.4, hUnit);
      // label rotated
      ctx.save();
      ctx.translate(x + barWidth * 0.4, canvas.height - 5);
      ctx.rotate(-Math.PI / 4);
      ctx.fillStyle = document.body.classList.contains('dark') ? '#eaeaea' : '#000';
      ctx.font = '10px sans-serif';
      ctx.fillText(lbl.substring(0, 10) + (lbl.length > 10 ? '‚Ä¶' : ''), 0, 0);
      ctx.restore();
    });
    // axis lines
    ctx.strokeStyle = document.body.classList.contains('dark') ? '#aaa' : '#333';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - 20);
    ctx.lineTo(canvas.width, canvas.height - 20);
    ctx.moveTo(0, 0);
    ctx.lineTo(0, canvas.height - 20);
    ctx.stroke();
  }
  // draw category charts
  const catCountCanvas = document.getElementById('catCountCanvas');
  const catCountCtx = catCountCanvas.getContext('2d');
  const catRevenueCanvas = document.getElementById('catRevenueCanvas');
  const catRevenueCtx = catRevenueCanvas.getContext('2d');
  // compute category counts and revenue
  const counts = {};
  const revSum = {};
  const revCount = {};
  products.forEach(item => {
    const cat = (item.category || '').trim().toLowerCase();
    if (!cat) return;
    counts[cat] = (counts[cat] || 0) + 1;
    // revenue
    let rev = 0;
    if (item.extras && item.extras['Revenue($)']) {
      const v = parseFloat(String(item.extras['Revenue($)']).replace(/[^0-9.-]+/g,''));
      if (!isNaN(v)) rev = v;
    }
    revSum[cat] = (revSum[cat] || 0) + rev;
    revCount[cat] = (revCount[cat] || 0) + (rev > 0 ? 1 : 0);
  });
  // sort categories by counts and take top 10
  const catEntries = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
  const catLabels = catEntries.map(e => e[0]);
  const catValues = catEntries.map(e => e[1]);
  // draw category counts bar chart
  catCountCtx.clearRect(0, 0, catCountCanvas.width, catCountCanvas.height);
  if (catLabels.length > 0) {
    const maxCount = Math.max(...catValues);
    const barWidth = catCountCanvas.width / (catLabels.length * 2);
    catLabels.forEach((lbl, idx) => {
      const x = idx * 2 * barWidth + barWidth * 0.5;
      const h = maxCount > 0 ? (catValues[idx] / maxCount) * (catCountCanvas.height - 40) : 0;
      catCountCtx.fillStyle = '#ffb74d';
      catCountCtx.fillRect(x, catCountCanvas.height - h - 20, barWidth * 0.8, h);
      catCountCtx.save();
      catCountCtx.translate(x + barWidth * 0.4, catCountCanvas.height - 5);
      catCountCtx.rotate(-Math.PI / 4);
      catCountCtx.fillStyle = document.body.classList.contains('dark') ? '#eaeaea' : '#000';
      catCountCtx.font = '10px sans-serif';
      catCountCtx.fillText(lbl.substring(0, 10) + (lbl.length > 10 ? '‚Ä¶' : ''), 0, 0);
      catCountCtx.restore();
    });
    // axis
    catCountCtx.strokeStyle = document.body.classList.contains('dark') ? '#aaa' : '#333';
    catCountCtx.beginPath();
    catCountCtx.moveTo(0, catCountCanvas.height - 20);
    catCountCtx.lineTo(catCountCanvas.width, catCountCanvas.height - 20);
    catCountCtx.moveTo(0, 0);
    catCountCtx.lineTo(0, catCountCanvas.height - 20);
    catCountCtx.stroke();
  }
  // compute average revenue per category for top categories
  const avgRev = catLabels.map(cat => {
    const sum = revSum[cat] || 0;
    const count = revCount[cat] || counts[cat];
    return count > 0 ? sum / count : 0;
  });
  // draw average revenue chart
  catRevenueCtx.clearRect(0, 0, catRevenueCanvas.width, catRevenueCanvas.height);
  if (catLabels.length > 0) {
    const maxRevAvg = Math.max(...avgRev);
    const barWidth2 = catRevenueCanvas.width / (catLabels.length * 2);
    catLabels.forEach((lbl, idx) => {
      const x = idx * 2 * barWidth2 + barWidth2 * 0.5;
      const h = maxRevAvg > 0 ? (avgRev[idx] / maxRevAvg) * (catRevenueCanvas.height - 40) : 0;
      catRevenueCtx.fillStyle = '#4db6ac';
      catRevenueCtx.fillRect(x, catRevenueCanvas.height - h - 20, barWidth2 * 0.8, h);
      catRevenueCtx.save();
      catRevenueCtx.translate(x + barWidth2 * 0.4, catRevenueCanvas.height - 5);
      catRevenueCtx.rotate(-Math.PI / 4);
      catRevenueCtx.fillStyle = document.body.classList.contains('dark') ? '#eaeaea' : '#000';
      catRevenueCtx.font = '10px sans-serif';
      catRevenueCtx.fillText(lbl.substring(0, 10) + (lbl.length > 10 ? '‚Ä¶' : ''), 0, 0);
      catRevenueCtx.restore();
    });
    catRevenueCtx.strokeStyle = document.body.classList.contains('dark') ? '#aaa' : '#333';
    catRevenueCtx.beginPath();
    catRevenueCtx.moveTo(0, catRevenueCanvas.height - 20);
    catRevenueCtx.lineTo(catRevenueCanvas.width, catRevenueCanvas.height - 20);
    catRevenueCtx.moveTo(0, 0);
    catRevenueCtx.lineTo(0, catRevenueCanvas.height - 20);
    catRevenueCtx.stroke();
  }
  chartDiv.style.display = 'block';
  // re-render table to show outlines for trending products
  renderTable();
};
</script>
<script src="/static/js/filters.js"></script>
</body>
</html>