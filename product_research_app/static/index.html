<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Product Research Copilot</title>
<link rel="stylesheet" href="/static/css/app.css">
<link rel="stylesheet" href="/static/css/toast.css">
<style>
/* Basic layout */
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, sans-serif; color:#222; background: linear-gradient(to bottom, #f8fbff, #e9f0ff); }
body.dark { background: #1a1b2e; color:#eaeaea; }
header { padding:20px; text-align:center; background: linear-gradient(90deg, #0062ff, #00c8ff); color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
body.dark header { background: linear-gradient(90deg, #2e2e78, #6547a6); }
.container { max-width: 1200px; margin: 0 auto; padding: 10px; }
.card { background:#fff; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); padding:15px; margin-bottom:15px; }
body.dark .card { background:#262a51; box-shadow:0 0 10px rgba(0,0,0,0.4); }
/* Controls */
#controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
button { padding:8px 14px; border:none; border-radius:4px; cursor:pointer; background: linear-gradient(90deg,#0062ff,#00c8ff); color:#fff; font-weight:600; box-shadow:0 3px 5px rgba(0,0,0,0.2); transition:opacity 0.2s; }
button:hover { opacity:0.85; }
body.dark button { background: linear-gradient(90deg,#3a3cad,#7a53d6); color:#fff; }
/* Chip style for filter toggle */
#btnFilters { background:#e0f0ff; border:1px solid #0077cc; color:#0077cc; padding:6px 10px; border-radius:16px; font-size:14px; }
body.dark #btnFilters { background:#2a2d5c; border-color:#7a53d6; color:#a9a9ff; }
select, input[type="text"], input[type="password"] { padding:6px; border-radius:4px; border:1px solid #ccc; }
body.dark select, body.dark input[type="text"], body.dark input[type="password"] { background:#1f2344; color:#eaeaea; border-color:#444; }
th, td { padding:8px; border:1px solid #ccc; }
body.dark th, body.dark td { border-color:#444; }
tbody tr:nth-child(even) { background:#f2f6ff; }
body.dark tbody tr:nth-child(even) { background:#2a2d5c; }
body.dark tbody tr:nth-child(odd) { background:#25285a; }
tbody tr:hover {
  box-shadow: 0 0 6px rgba(0,0,0,0.2);
  transform: translateY(-2px);
  transition: box-shadow 0.2s, transform 0.2s;
}
#importBanner { background:rgba(122,83,214,0.2); color:#7a53d6; border:1px solid rgba(122,83,214,0.3); }
body.dark #importBanner { background:rgba(122,83,214,0.2); color:#c9b9f3; border:1px solid rgba(122,83,214,0.4); }
/* History & Details */
#history details { margin-bottom:8px; }
details summary { cursor:pointer; font-weight:600; color:#0062ff; }
body.dark details summary { color:#80b3ff; }
pre { white-space:pre-wrap; background:#f5f7ff; padding:8px; border-radius:4px; }
body.dark pre { background:#2e315f; }
/* Weight slider styling */
</style>
</head>
<body class="dark">
<div id="topBar">
  <header style="padding:8px 15px; display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:8px;">
      <h1 style="margin:0; font-size:1.4rem;">Ecom Testing App</h1>
      <p style="margin:0;font-size:12px; opacity:0.8;">By El Tito ü§ô</p>
    </div>
    <div style="flex:1; display:flex; justify-content:flex-end; gap:8px; align-items:center;">
      <input type="file" id="fileInput" style="display:none;" />
      <button id="uploadBtn" title="Subir archivo">üì§</button>
      <button id="refreshBtn" title="Actualizar lista">üîÑ</button>
      <button id="trendsBtn" title="Ver tendencias">üìä</button>
      <button id="darkToggle" title="Modo oscuro">üåô</button>
      <button id="configBtn" title="Configuraci√≥n avanzada">‚öôÔ∏è</button>
    </div>
  </header>
  <!-- Search bar row with controls -->
  <div id="searchRow">
    <input type="text" id="searchInput" placeholder="Buscar producto o palabra clave..." aria-label="Buscar productos" />
    <button id="searchBtn">Buscar</button>
    <button id="btnFilters">Filtros</button>
    <div id="activeFilterChips"></div>
    <input type="text" id="newListName" placeholder="Nombre del grupo" style="padding:4px; min-width:120px;">
    <button id="createListBtn">Crear</button>
    <textarea id="gptPrompt" rows="1" maxlength="2000" placeholder="Escribe consulta para GPT..." aria-label="Escribe consulta para GPT..."></textarea>
    <div id="gptActions">
      <button id="sendPrompt">Enviar consulta a GPT</button>
      <button id="btnGenWinner" class="bar-btn" disabled title="Generar Winner Score" aria-label="Generar Winner Score">Generar Winner Score</button>
    </div>
    <div id="searchRowRight">
      <div id="listMeta">0 resultados</div>
    </div>
  </div>
</div>
<div id="importBanner" style="display:none; padding:8px; text-align:center;"></div>
<div id="config" style="display:none;">
  <div class="config-controls">
    <label for="modelSelect">Modelo</label>
    <select id="modelSelect">
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4">GPT-4</option>
      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
    </select>
    <button id="toggleApiKey" type="button" style="display:none;">Cambiar API Key</button>
  </div>
  <div class="api-row">
    <label for="apiKey">API Key</label>
    <div class="api-input-row">
      <input type="password" id="apiKey" />
      <button id="saveApiKey" disabled aria-label="Guardar API Key" title="Guardar API Key">Guardar API Key</button>
    </div>
  </div>
</div>
<div id="weightsCard" class="card" style="display:none;">
  <strong>Ponderaciones Winner Score</strong>
  <ul id="weightsList" style="list-style:none; margin-top:8px; padding:0;"></ul>
  <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px;">
    <button id="resetWeights">Reset</button>
    <button id="aiWeights">Ajustar pesos con IA</button>
  </div>
</div>
<div id="custom" style="display:none;">
  <div id="history" style="margin-top:10px;"></div>
</div>
<div id="trends" class="card" style="display:none;"></div>
<!-- Chart container for trends -->
<div id="chartContainer" class="card" style="display:none;">
  <div id="trendControls" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-bottom:20px;">
    <div><label>Desde: <input type="date" id="trendStart"></label></div>
    <div><label>Hasta: <input type="date" id="trendEnd"></label></div>
    <div><label>M√©trica:
      <select id="metricSelect">
        <option value="revenue">Ingresos</option>
        <option value="units">Unidades</option>
        <option value="avg_price">Avg. Unit Price</option>
      </select>
    </label></div>
    <button id="applyTrendFilters">Aplicar</button>
  </div>
  <div id="kpiPanel" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:space-around; margin-bottom:20px;"></div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Comparativo por categor√≠a</h3>
    <canvas id="catCompareCanvas" style="width:100%; height:400px;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Resumen por categor√≠a</h3>
    <table id="categorySummaryTable"></table>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Top categor√≠as por crecimiento en ingresos</h3>
    <canvas id="catRevenueGrowthCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Top categor√≠as por crecimiento en unidades</h3>
    <canvas id="catUnitGrowthCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Ingresos/unidades por categor√≠a</h3>
    <canvas id="catRevPerUnitCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Palabras clave destacadas</h3>
    <canvas id="keywordTrendCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Marcas m√°s repetidas</h3>
    <canvas id="brandTrendCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Rating vs Ingresos</h3>
    <canvas id="ratingRevenueCanvas" style="width:100%; height:400px;"></canvas>
  </div>
  <div style="width:100%;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Precio promedio vs Ingresos</h3>
    <canvas id="priceRevenueCanvas" style="width:100%; height:400px;"></canvas>
  </div>
</div>

  <table id="productTable">
  <thead class="sticky-thead">
    <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>
<div id="bottomBar" class="bottombar hidden">
  <button id="legendBtn" class="legend-btn" title="Mostrar leyenda" aria-label="Mostrar leyenda">‚ÑπÔ∏è</button>
  <span id="selCount"></span>
  <select id="groupSelect" aria-label="Filtrar por grupo"></select>
  <button id="btnAddToGroup" class="bar-btn" disabled title="A√±adir seleccionados al grupo" aria-label="A√±adir seleccionados al grupo">A√±adir a grupo</button>
  <button id="btnManageGroups" class="bar-btn" title="Gestionar grupos" aria-label="Gestionar grupos">Gestionar grupos</button>
  <button id="btnDelete" class="bar-btn" disabled title="Eliminar seleccionados" aria-label="Eliminar seleccionados">Eliminar</button>
  <button id="btnExport" class="bar-btn" disabled title="Exportar seleccionados" aria-label="Exportar seleccionados">Exportar</button>
  <button id="btnColumns" class="bar-btn" title="Gestionar columnas" aria-label="Gestionar columnas">Columnas</button>
</div>
<div id="legendPop" class="popover hidden">
  <div>‚Ä¢ Fila roja: duplicado</div>
  <div>‚Ä¢ üî• x1‚Äìx5: tendencia en el nombre</div>
</div>
<div id="columnsPanel" class="popover hidden"></div>

<!-- Overlay for viewing images in larger size -->
<div id="imgOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
  <img id="overlayImg" src="" style="max-width:90%; max-height:90%; box-shadow:0 0 10px #000; border-radius:8px;" />
</div>
<!-- Progress bar for micro interactions -->
<div id="progressBar" style="position:fixed; top:0; left:0; height:3px; background:#0077cc; width:0%; display:none; z-index:3000;"></div>
<!-- Loading overlay shown during file uploads -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); color:#fff; font-size:20px; align-items:center; justify-content:center; z-index:2000;">
  <div style="text-align:center;">
    <div class="spinner" style="margin-bottom:10px; width:40px; height:40px; border:5px solid #f3f3f3; border-top:5px solid #0062ff; border-radius:50%; animation: spin 1s linear infinite;"></div>
    <div>Cargando archivo...</div>
  </div>
</div>
<div id="filtersDrawer" class="drawer right hidden">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>Filtros</h3>
    <button id="closeFilters">√ó</button>
  </div>
  <div style="display:flex; flex-direction:column; gap:8px;">
    <label>Precio m√≠n<br><input type="number" id="filterPriceMin"></label>
    <label>Precio m√°x<br><input type="number" id="filterPriceMax"></label>
    <label>Fecha desde<br><input type="date" id="filterDateMin"></label>
    <label>Fecha hasta<br><input type="date" id="filterDateMax"></label>
    <label>Rating m√≠n<br><input type="number" id="filterRatingMin" step="0.1" min="0" max="5"></label>
    <label>Categor√≠a<br><input type="text" id="filterCategory"></label>
  </div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button id="applyFilters" style="flex:1;">Aplicar</button>
    <button id="clearFilters" style="flex:1;">Limpiar</button>
  </div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script src="/static/js/overlay.js"></script>
<script src="/static/js/toast.js"></script>
<script src="/static/js/table.js"></script>
<script src="/static/js/columns.js"></script>
<script type="module" src="/static/js/add-group.js"></script>
<script type="module" src="/static/js/manage-groups.js"></script>
<script src="/static/js/winner_score.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
import * as api from "/static/js/net.js";
import * as groupsService from "/static/js/groups-service.js";
const { fetchJson } = api;
window.fetchJson = fetchJson;
window.groupsService = groupsService;
const IMPORT_TASK_LS_KEY = 'last_import_task';
let importPollTimer = null;
let savedApiKeyHash = null;
let savedApiKeyLength = 0;

function formatPrice(n) {
  const num = Number(n);
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 })
    .format(Number.isFinite(num) ? num : 0);
}

const hasText = v => typeof v === 'string' ? v.trim().length > 0 : v != null;

function showImportBanner(msg) {
  const b = document.getElementById('importBanner');
  if (!b) return;
  b.textContent = msg;
  b.style.display = 'block';
}

function hideImportBanner() {
  const b = document.getElementById('importBanner');
  if (b) b.style.display = 'none';
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hashBuf = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hashBuf))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

async function pollImportStatus(id) {
  try {
    const data = await fetchJson(`/_import_status?task_id=${id}`);
    if (data.status === 'pending') {
      if (data.ui_cost_message) showImportBanner(data.ui_cost_message);
      importPollTimer = setTimeout(() => pollImportStatus(id), 2000);
    } else if (data.status === 'ai') {
      if (data.ui_cost_message) showImportBanner(data.ui_cost_message);
      importPollTimer = setTimeout(() => pollImportStatus(id), 2000);
    } else {
      localStorage.removeItem(IMPORT_TASK_LS_KEY);
      if (data.status === 'done') {
        await reloadTable();
        hideImportBanner();
      } else {
        toast.error(data.error || 'Error en importaci√≥n');
      }
    }
  } catch (e) {
    importPollTimer = setTimeout(() => pollImportStatus(id), 4000);
  }
}
// Ensure the server shuts down cleanly when the tab or window is closed.
// Using fetch with `keepalive` guarantees the request completes even during unload.
window.addEventListener('beforeunload', () => {
  try {
    // Use fetch() instead of sendBeacon() because some browsers
    // drop beacon requests when no payload is provided. The `keepalive`
    // option allows the request to continue in the background while
    // the page is unloading.
    fetch('/shutdown', { method: 'POST', keepalive: true });
  } catch (err) {
    // As a fallback, attempt a minimal beacon with an empty payload.
    try { navigator.sendBeacon('/shutdown', ''); } catch (e) {}
  }
});
// Global arrays to hold all products and the current filtered list
let allProducts = [];
let products = [];
let sortField = null;
let sortDir = 1;
let sortType = 'string';
function updateResultsBadge(total) {
  const meta = document.getElementById('listMeta');
  if (!meta) return;
  const count = typeof total === 'number' ? total : (Array.isArray(products) ? products.length : 0);
  meta.textContent = `${count} resultados`;
}

window.updateResultsBadge = updateResultsBadge;
window.allProducts = allProducts;
window.products = products;
const gridRoot = document.getElementById('productTable');

function ecMakeMeasurer() {
  const el = document.createElement('span');
  el.id = 'ec-measure';
  el.style.position = 'absolute';
  el.style.visibility = 'hidden';
  el.style.height = 'auto';
  el.style.width = 'auto';
  el.style.whiteSpace = 'pre';
  el.style.font = 'inherit';
  el.style.letterSpacing = 'inherit';
  document.body.appendChild(el);
  return el;
}
const __ecMeasure = ecMakeMeasurer();

function ecTextPxWidth(text, sampleEl) {
  __ecMeasure.style.font = getComputedStyle(sampleEl).font;
  __ecMeasure.textContent = text || '';
  return __ecMeasure.offsetWidth;
}

const EC_LIMITS = {
  desire:         { min: 120, max: 320, pad: 24 },
  desire_mag:     { min:  90, max: 160, pad: 20 },
  awareness:      { min: 140, max: 220, pad: 20 },
  competition:    { min: 100, max: 160, pad: 20 },
};

function ecClamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function ecAutoFitColumns(gridRoot) {
  const desired = { desire: EC_LIMITS.desire.min, desire_mag: EC_LIMITS.desire_mag.min,
                    awareness: EC_LIMITS.awareness.min, competition: EC_LIMITS.competition.min };

  const rows = gridRoot.querySelectorAll('tr');
  rows.forEach(tr => {
    const tdDesire   = tr.querySelector('td.ec-col-desire textarea');
    const tdMag      = tr.querySelector('td.ec-col-desire-mag select');
    const tdAware    = tr.querySelector('td.ec-col-awareness select');
    const tdComp     = tr.querySelector('td.ec-col-competition select');

    if (tdDesire) {
      const txt = tdDesire.value || tdDesire.placeholder || '';
      const w = ecTextPxWidth(txt, tdDesire) + EC_LIMITS.desire.pad;
      desired.desire = Math.max(desired.desire, w);
    }
    if (tdMag) {
      const lbl = tdMag.options[tdMag.selectedIndex]?.text || '‚Äî';
      const w = ecTextPxWidth(lbl, tdMag) + EC_LIMITS.desire_mag.pad;
      desired.desire_mag = Math.max(desired.desire_mag, w);
    }
    if (tdAware) {
      const lbl = tdAware.options[tdAware.selectedIndex]?.text || '‚Äî';
      const w = ecTextPxWidth(lbl, tdAware) + EC_LIMITS.awareness.pad;
      desired.awareness = Math.max(desired.awareness, w);
    }
    if (tdComp) {
      const lbl = tdComp.options[tdComp.selectedIndex]?.text || '‚Äî';
      const w = ecTextPxWidth(lbl, tdComp) + EC_LIMITS.competition.pad;
      desired.competition = Math.max(desired.competition, w);
    }
  });

  const d  = ecClamp(desired.desire,       EC_LIMITS.desire.min,      EC_LIMITS.desire.max);
  const dm = ecClamp(desired.desire_mag,   EC_LIMITS.desire_mag.min,  EC_LIMITS.desire_mag.max);
  const aw = ecClamp(desired.awareness,    EC_LIMITS.awareness.min,   EC_LIMITS.awareness.max);
  const co = ecClamp(desired.competition,  EC_LIMITS.competition.min, EC_LIMITS.competition.max);

  gridRoot.style.setProperty('--ec-w-desire',        d  + 'px');
  gridRoot.style.setProperty('--ec-w-desire-mag',    dm + 'px');
  gridRoot.style.setProperty('--ec-w-awareness',     aw + 'px');
  gridRoot.style.setProperty('--ec-w-competition',   co + 'px');

  gridRoot.querySelectorAll('td.ec-col-desire textarea').forEach(el => el.style.width = (d - EC_LIMITS.desire.pad) + 'px');
  gridRoot.querySelectorAll('td.ec-col-desire-mag select').forEach(el => el.style.width = (dm - EC_LIMITS.desire_mag.pad) + 'px');
  gridRoot.querySelectorAll('td.ec-col-awareness select').forEach(el => el.style.width = (aw - EC_LIMITS.awareness.pad) + 'px');
  gridRoot.querySelectorAll('td.ec-col-competition select').forEach(el => el.style.width = (co - EC_LIMITS.competition.pad) + 'px');
}
const columns = [
  { key: 'id', label: 'ID', type: 'number' },
  { key: 'image_url', label: 'Imagen', type: 'image' },
  { key: 'name', label: 'Nombre', type: 'string' },
  { key: 'category', label: 'Categor√≠a', type: 'string' },
  { key: 'price', label: 'Price', type: 'number', align: 'center', editable: false,
    headerClass:'price-col', cellClass:'price-col',
    render: row => new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits: 2 }).format(row.price ?? 0) },
  { key: 'Product Rating', label: 'Rating', type: 'number' },
  { key: 'Item Sold', label: 'Unidades Vendidas', type: 'number' },
  { key: 'Revenue($)', label: 'Ingresos', type: 'number' },
  { key: 'Creator Conversion Ratio', label: 'Tasa Conversi√≥n', type: 'string' },
  { key: 'Launch Date', label: 'Fecha Lanzamiento', type: 'string' },
  { key: 'date_range', label: 'Rango Fechas', type: 'string', headerClass: 'cell-date-range', cellClass: 'cell-date-range' },
  { key: 'desire', label: 'Desire', type: 'string', headerClass: 'ec-col ec-col-desire', cellClass: 'ec-col ec-col-desire', dataEcCol: 'desire', align: 'center', width: 360 },
  { key: 'desireMagnitude', label: 'Desire magnitude', type: 'string', headerClass: 'ec-col ec-col-desire-mag', cellClass: 'ec-col ec-col-desire-mag', dataEcCol: 'desire_magnitude', align: 'center' },
  { key: 'awareness_level', label: 'Awerness Level', type: 'string', headerClass: 'ec-col ec-col-awareness', cellClass: 'ec-col ec-col-awareness', dataEcCol: 'awareness_level' },
  { key: 'competition_level', label: 'Competition level', type: 'string', headerClass: 'ec-col ec-col-competition', cellClass: 'ec-col ec-col-competition', dataEcCol: 'competition_level' },
  { key: 'winner_score', label: 'Winner Score', type: 'number' },
];

let trendingWords = [];

function mapTrendingScore(raw){
  const n = Number(raw);
  if (isNaN(n)) return 0;
  if (n <= 5) return Math.max(0, Math.round(n));
  if (n <= 9) return 0;
  if (n <= 19) return 1;
  if (n <= 34) return 2;
  if (n <= 54) return 3;
  if (n <= 79) return 4;
  return 5;
}

function normalizeDupKey(item){
  const norm = (str) => (str || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, ' ')
    .trim()
    .replace(/\s+/g, ' ');
  return norm(item.name) + '|' + norm(item.image_url);
}

function preprocessProducts(list){
  const dupMap = new Map();
  list.forEach(item => {
    item.trending = mapTrendingScore(item.trendingScore);
    item.desire = typeof item.desire === 'string'
      ? item.desire.trim()
      : (item.desire ?? '');
    if (item.extras && item.extras['duplicate_of']) {
      item.isDuplicate = true;
      return;
    }
    const key = normalizeDupKey(item);
    item._dupKey = key;
    const arr = dupMap.get(key);
    if (arr) arr.push(item); else dupMap.set(key, [item]);
  });
  dupMap.forEach(arr => { if (arr.length > 1) arr.forEach(it => it.isDuplicate = true); });
}

const WEIGHT_KEYS = ['price','rating','units_sold','revenue','desire','competition','review_count','image_count','profit_margin','shipping_days'];
const ALIASES = { unitsSold:'units_sold', orders:'units_sold', reviews:'review_count', imgs:'image_count', ship_days:'shipping_days' };
function normalizeKey(k){ return ALIASES[k] || k; }
const metricDefs = [
  {key:'price',label:'Price'},
  {key:'rating',label:'Rating'},
  {key:'units_sold',label:'Units Sold'},
  {key:'revenue',label:'Revenue'},
  {key:'desire',label:'Desire'},
  {key:'competition',label:'Competition'},
  {key:'review_count',label:'Review Count'},
  {key:'image_count',label:'Image Count'},
  {key:'profit_margin',label:'Profit Margin'},
  {key:'shipping_days',label:'Shipping Days'}
];
const metricKeys = metricDefs.map(m=>m.key);
let weightValues = {};
let weightOrder = [];

function debounce(fn, ms=150){
  let t, lastArgs;
  function wrapped(...args){
    lastArgs = args;
    clearTimeout(t);
    t = setTimeout(()=>fn(...lastArgs), ms);
  }
  wrapped.flush = () => {
    if(t){
      clearTimeout(t);
      fn(...lastArgs);
    }
  };
  return wrapped;
}

function defaultWeights(){ const o={}; WEIGHT_KEYS.forEach(k=>o[k]=0); return o; }
function defaultOrder(){ return [...WEIGHT_KEYS]; }

const saveFns = {};
function saveWeightDebounced(key, value){
  if(!saveFns[key]){
    saveFns[key] = debounce(val=>{
      fetch('/api/config/winner-weights', {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ key, value: val })
      }).then(()=> showSavedTick(key));
    },300);
  }
  saveFns[key](value);
}

function showSavedTick(key){
  const el = document.querySelector(`#weightsList li[data-key="${key}"] .ws-status`);
  if(el){ el.textContent='‚úì'; setTimeout(()=>{ el.textContent=''; },1000); }
}

function updateSliderLabel(el) {
  const num = Math.round(Number(el.value) || 0);
  el.nextElementSibling?.querySelector('.weight-value')?.replaceChildren(document.createTextNode(String(num)));
}

function renderWeights(){
  const list=document.getElementById('weightsList');
  if(!list) return;
  list.innerHTML='';
  weightOrder.forEach(key=>{
    const def=metricDefs.find(m=>m.key===key);
    const li=document.createElement('li');
    li.className='metric-row';
    li.dataset.key=key;
    li.innerHTML=`<span class="ws-handle">‚â°</span><span class="ws-name">${def.label}</span><div class="ws-slider-wrap"><input type="range" name="${key}" min="0" max="100" step="1" value="${Math.round(weightValues[key]||0)}" class="ws-slider"><span class="ws-value"><span class="weight-value"></span></span></div><span class="ws-status"></span>`;
    const range=li.querySelector('.ws-slider');
    range.addEventListener('input',e=>{
      const k=normalizeKey(e.target.name);
      const v=Math.round(parseFloat(e.target.value));
      e.target.value = v;
      weightValues[k]=v;
      updateSliderLabel(range);
      if(Number.isFinite(v)) saveWeightDebounced(k, v);
    });
    ['mousedown','touchstart'].forEach(ev=>{ range.addEventListener(ev,e=>{ e.stopPropagation(); }); });
    updateSliderLabel(range);
    list.appendChild(li);
  });
  Sortable.create(list,{ handle:'.ws-handle', animation:150, onEnd:()=>{ weightOrder=Array.from(list.children).map(li=>li.dataset.key); }});
}

function resetWeights(){
  weightValues=defaultWeights();
  weightOrder=defaultOrder();
  renderWeights();
  for(const k in weightValues){ saveWeightDebounced(k, weightValues[k]); }
}

function stratifiedSample(list, n){
  const byCat = {};
  list.forEach(p=>{ const c = p.category || 'N/A'; (byCat[c] = byCat[c] || []).push(p); });
  const total = list.length;
  const sample = [];
  for(const c in byCat){
    const arr = byCat[c].slice().sort((a,b)=>{
      const ra = Number(a.revenue || (a.extras && a.extras['Revenue($)']) || 0);
      const rb = Number(b.revenue || (b.extras && b.extras['Revenue($)']) || 0);
      const ua = Number(a.units_sold || (a.extras && a.extras['Item Sold']) || 0);
      const ub = Number(b.units_sold || (b.extras && b.extras['Item Sold']) || 0);
      const sa = ra || ua;
      const sb = rb || ub;
      return sb - sa;
    });
    const k = Math.max(1, Math.round(n * arr.length / total));
    sample.push(...arr.slice(0,k));
  }
  return sample.slice(0,n);
}

async function adjustWeightsAI(){
  try{
    let sample=stratifiedSample(allProducts||[],30);
    let payload=sample.map(p=>({name:p.name,category:p.category,price:p.price,units:p.units_sold||(p.extras&&p.extras['Item Sold'])||0,ingresos:p.revenue||(p.extras&&p.extras['Revenue($)'])||0,conversion:p.extras&&p.extras['Creator Conversion Ratio'],fecha:p.extras&&p.extras['date_range'],desire:p.desire_magnitude,awareness:p.awareness_level,competition:p.competition_level}));
    let tokenEstimate=JSON.stringify(payload).length/4;
    const maxTokens=0.30/0.002*1000;
    while(tokenEstimate>maxTokens && sample.length>1){
      const ratio=maxTokens/tokenEstimate;
      const newN=Math.max(1,Math.floor(sample.length*ratio));
      sample=stratifiedSample(allProducts||[],newN);
      payload=sample.map(p=>({name:p.name,category:p.category,price:p.price,units:p.units_sold||(p.extras&&p.extras['Item Sold'])||0,ingresos:p.revenue||(p.extras&&p.extras['Revenue($)'])||0,conversion:p.extras&&p.extras['Creator Conversion Ratio'],fecha:p.extras&&p.extras['date_range'],desire:p.desire_magnitude,awareness:p.awareness_level,competition:p.competition_level}));
      tokenEstimate=JSON.stringify(payload).length/4;
    }
    const cost=tokenEstimate/1000*0.002;
    toast.info(`Analizando ${sample.length} productos (~$${cost.toFixed(2)})`);
    const instruction='Devuelve SOLO un JSON plano con pesos 0-100 para estas 10 claves exactas, sin texto adicional:\n["magnitud_deseo","nivel_consciencia_headroom","evidencia_demanda","tasa_conversion","ventas_por_dia","recencia_lanzamiento","competition_level_invertido","facilidad_anuncio","escalabilidad","durabilidad_recurrencia"]';
    const prompt=`Basado en estos productos ${JSON.stringify(payload)}\n${instruction}`;
    let res=await fetch('/custom_gpt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,response_format:{type:'json_object'}})});
    if(!res.ok){
      toast.error('No se pudo ajustar por IA. Revisa tu API Key o int√©ntalo m√°s tarde.');
      return;
    }
    const data=await res.json();
    let raw=data.response||'';
    console.debug('IA raw:', raw);
    let obj;
    if(typeof raw==='string'){
      try{ obj=JSON.parse(raw); }
      catch(e){
        const m=raw.match(/\{[\s\S]*\}/);
        if(m){ try{ obj=JSON.parse(m[0]); } catch(e2){} }
      }
    }else if(typeof raw==='object'){
      obj=raw;
    }
    console.debug('IA parsed:', obj);
    if(!obj || typeof obj!=='object'){
      toast.error('No se pudo ajustar por IA. Revisa tu API Key o int√©ntalo m√°s tarde.');
      return;
    }
    const newWeights={};
    for(const k of metricKeys){
      let v=Number(obj[k]);
      if(isNaN(v)) v=Number(weightValues[k])||0;
      if(v<0) v=0; if(v>100) v=100;
      newWeights[k]=Math.round(v);
    }
    weightValues=newWeights;
    renderWeights();
    for(const k in weightValues){ saveWeightDebounced(k, weightValues[k]); }
    toast.success('Pesos ajustados por IA');
  }catch(err){
    console.error(err);
    toast.error('No se pudo ajustar por IA. Revisa tu API Key o int√©ntalo m√°s tarde.');
  }
}


async function loadWeights(){
  try{
    const res = await fetch('/api/config/winner-weights');
    const { weights } = await res.json();
    weightValues = {};
    for(const k in weights){ weightValues[k] = Math.round(weights[k]); }
    weightOrder = defaultOrder();
    renderWeights();
    document.getElementById('resetWeights').onclick = resetWeights;
    const aiBtn=document.getElementById('aiWeights');
    if(aiBtn) aiBtn.onclick=adjustWeightsAI;
  }catch(err){
    console.error('Error loading weights', err);
  }
}

async function loadConfig() {
  let cfg = {};
  try {
    cfg = await fetchJson('/config');
  } catch (err) {
    console.error('Error loading config', err);
  }
  if (cfg.model) {
    document.getElementById('modelSelect').value = cfg.model;
  }
  const input = document.getElementById('apiKey');
  const saveBtn = document.getElementById('saveApiKey');
  if (cfg.has_api_key) {
    savedApiKeyHash = cfg.api_key_hash || null;
    savedApiKeyLength = cfg.api_key_length || 0;
    const masked = '‚Ä¢'.repeat(Math.max(savedApiKeyLength - 4, 0)) + (cfg.api_key_last4 || '');
    if (input) input.value = masked;
    if (saveBtn) saveBtn.disabled = true;
    const row = document.querySelector('#config .api-row');
    if (row) row.style.display = 'none';
    document.getElementById('toggleApiKey').style.display = 'inline-flex';
  } else {
    savedApiKeyHash = null;
    savedApiKeyLength = 0;
    if (input) input.value = '';
    if (saveBtn) saveBtn.disabled = true;
  }
  await loadWeights();
}

// Microinteraction progress bar
function startProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.display = 'block';
  bar.style.width = '0%';
  let progress = 0;
  const interval = setInterval(() => {
    progress += 10;
    bar.style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        bar.style.display = 'none';
        bar.style.width = '0%';
      }, 200);
    }
  }, 30);
}

// helper to highlight trending keywords
function isTrending(name) {
  if (!name) return false;
  const words = name.toLowerCase().split(/[^a-z0-9√°√©√≠√≥√∫√º√±]+/);
  return words.some(w => trendingWords.includes(w));
}

async function fetchProducts(preserve=true) {
  const prevSel = new Set(selection);
  const data = await fetchJson('/products');
  if(data.length && data[0].desire !== undefined && window.ensureColumnVisible){
    ensureColumnVisible('desire');
  }
  allProducts = data;
  preprocessProducts(allProducts);
  allProducts.sort((a,b)=> (Number(a.id)||0) - (Number(b.id)||0));
  sortField = 'id';
  sortDir = 1;
  sortType = 'number';
  products = [...allProducts];
  window.allProducts = allProducts;
  window.products = products;
  if (typeof filtersState !== 'undefined' && preserve) {
    applyFiltersFromState();
  } else {
    renderTable();
  }
  const visibleIds = new Set(products.map(p => String(p.id)));
  selection.clear();
  for (const id of prevSel) {
    if (visibleIds.has(id)) selection.add(id);
  }
  updateMasterState();
  renderTable();
}

window.fetchProducts = fetchProducts;
async function reloadTable(){ await fetchProducts(); }
async function reloadRows(ids){ await fetchProducts(); }

function renderTable() {
  const headerRow = document.getElementById('headerRow');
  const tbody = document.querySelector('#productTable tbody');
  // Build header if empty
  if (!headerRow.hasChildNodes()) {
    // Add select column header (no label)
    const thSel = document.createElement('th');
    const selectAll = document.createElement('input');
    selectAll.type = 'checkbox';
    selectAll.id = 'selectAll';
    thSel.appendChild(selectAll);
    headerRow.appendChild(thSel);
    // Add dynamic columns
    columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col.label;
      th.style.cursor = 'pointer';
      th.setAttribute('data-key', col.key);
      if (col.headerClass) th.className = col.headerClass;
      if (col.dataEcCol) th.setAttribute('data-ec-col', col.dataEcCol);
      if (col.width) th.style.width = col.width + 'px';
      if (col.minWidth) th.style.minWidth = col.minWidth + 'px';
      if (col.maxWidth) th.style.maxWidth = col.maxWidth + 'px';
      if (col.align) th.style.textAlign = col.align;
      if (col.key === 'winner_score') th.title = 'Suma ponderada de 10 m√©tricas normalizadas';
      th.onclick = () => sortBy(col.key, col.type);
      headerRow.appendChild(th);
    });
    // Add delete column header
    const thDel = document.createElement('th');
    headerRow.appendChild(thDel);
  }
  // Clear body
  tbody.innerHTML = '';
  // Render rows
    products.forEach(item => {
    const tr = document.createElement('tr');
    if (item.isDuplicate) {
      tr.classList.add('is-duplicate');
    }
    // Selection checkbox
    const tdSel = document.createElement('td');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.classList.add('rowCheck');
    const rowId = String(item.id);
    cb.dataset.id = rowId;
    cb.checked = selection.has(rowId);
    tr.classList.toggle('selected', cb.checked);
    cb.addEventListener('change', () => {
      const id = cb.dataset.id;
      if (cb.checked) selection.add(id); else selection.delete(id);
      tr.classList.toggle('selected', cb.checked);
      updateMasterState();
    });
    tdSel.appendChild(cb);
    tr.appendChild(tdSel);
    columns.forEach(col => {
      const td = document.createElement('td');
      const key = col.key;
      td.setAttribute('data-key', key);
      if (col.cellClass) td.className = col.cellClass;
      if (col.dataEcCol) td.setAttribute('data-ec-col', col.dataEcCol);
      if (col.width) td.style.width = col.width + 'px';
      if (col.minWidth) td.style.minWidth = col.minWidth + 'px';
      if (col.maxWidth) td.style.maxWidth = col.maxWidth + 'px';
      if (col.align) td.style.textAlign = col.align;
      let value = '';
      if (metricKeys.includes(key)) {
        value = item.winner_score_breakdown && item.winner_score_breakdown.scores ? item.winner_score_breakdown.scores[key] : '';
        if (item.winner_score_breakdown && item.winner_score_breakdown.justifications) {
          const j = item.winner_score_breakdown.justifications[key];
          if (j) td.title = 'Justificaci√≥n: ' + j;
        }
      } else if (key === 'desire') {
        value = typeof item.desire === 'string' ? item.desire.trim() : (item.desire ?? '');
      } else if (key === 'desireMagnitude') {
        value = item.desire_magnitude;
      } else if (['id','name','category','price','image_url','winner_score','awareness_level','competition_level','date_range'].includes(key)) {
        value = item[key];
      } else {
        value = item.extras ? item.extras[key] : '';
      }
      if (col.render) {
        try { td.textContent = col.render(item); } catch (e) { td.textContent = ''; }
      } else if (key === 'winner_score') {
        const sc = parseFloat(value);
        if (!isNaN(sc)) {
          const scInt = Math.round(sc);
          td.innerHTML = '<span class="' + winnerScoreClass(scInt) + '">' + scInt.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span>';
          if (item.winner_score_breakdown && item.winner_score_breakdown.justifications) {
            const j = item.winner_score_breakdown.justifications;
            const tooltip = Object.entries(j).map(([k,v])=>`${k}: ${v}`).join('\n');
            td.title = tooltip;
          }
        }
      } else if (key === 'image_url' && value) {
        const img = document.createElement('img');
        img.src = value;
        // Increase the preview size for better visibility
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        // Show larger image on click
        img.style.cursor = 'pointer';
        img.onclick = () => {
          showOverlay(value);
        };
        td.appendChild(img);
      } else if (key === 'name' && value) {
        const fireCount = item.trending || 0;
        const fireText = firesFor(fireCount);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = value + (fireText ? ' ' : '');
        td.appendChild(nameSpan);
        if (fireCount > 0) {
          const fireSpan = document.createElement('span');
          fireSpan.className = 'fires';
          fireSpan.textContent = fireText;
          fireSpan.setAttribute('aria-label', `Tendencia: x${fireCount}`);
          fireSpan.title = `Tendencia: x${fireCount}`;
          td.appendChild(fireSpan);
        }
        // If Kalodata URL exists, add copy link button
        const kal = item.extras && item.extras['KalodataUrl'];
        if (kal) {
          const btnCopy = document.createElement('button');
          btnCopy.textContent = 'üìã';
          btnCopy.title = 'Copiar link Kalodata';
          btnCopy.style.marginLeft = '5px';
          btnCopy.style.padding = '2px 6px';
          btnCopy.style.fontSize = '12px';
          btnCopy.onclick = () => {
            navigator.clipboard.writeText(kal).then(() => {
              toast.success('Link copiado al portapapeles');
            });
          };
          td.appendChild(btnCopy);
        }
      } else if (key === 'desire') {
        const initial = value || '';
        let localVal = initial;
        const ta = document.createElement('textarea');
        ta.placeholder = '‚Äî';
        ta.rows = 2;
        ta.className = 'cell-textarea center';
        ta.value = initial;
        ta.title = initial;
        td.title = initial;
        const save = debounce(async next => {
          const trimmed = (next || '').trim();
          const prev = item.desire || '';
          item.desire = trimmed;
          td.title = trimmed;
          try {
            await api.updateProductField(item.id, { desire: trimmed });
            ecAutoFitColumns(gridRoot);
          } catch (e) {
            item.desire = prev;
            ta.value = prev;
            td.title = prev;
            toast.error('No se pudo guardar Desire');
          }
        }, 500);
        ta.addEventListener('input', e => {
          localVal = e.target.value;
          save(localVal);
        });
        ta.addEventListener('blur', () => save.flush && save.flush());
        td.appendChild(ta);
      } else if (key === 'desireMagnitude') {
        const select = document.createElement('select');
        ['', 'Low', 'Medium', 'High'].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt || '‚Äî';
          if (value === opt) o.selected = true;
          select.appendChild(o);
        });
        select.addEventListener('change', async () => {
          const val = select.value || null;
          try { await fetchJson(`/products/${item.id}`, {method:'PUT', body: JSON.stringify({desire_magnitude: val})}); } catch(e) {}
          item.desire_magnitude = val;
        });
        td.appendChild(select);
      } else if (key === 'awareness_level') {
        const select = document.createElement('select');
        ['', 'Unaware', 'Problem-Aware', 'Solution-Aware', 'Product-Aware', 'Most Aware'].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt || '‚Äî';
          if (value === opt) o.selected = true;
          select.appendChild(o);
        });
        select.addEventListener('change', async () => {
          const val = select.value || null;
          try { await fetchJson(`/products/${item.id}`, {method:'PUT', body: JSON.stringify({awareness_level: val})}); } catch(e) {}
          item.awareness_level = val;
        });
        td.appendChild(select);
      } else if (key === 'competition_level') {
        const select = document.createElement('select');
        ['', 'Low', 'Medium', 'High'].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt || '‚Äî';
          if (value === opt) o.selected = true;
          select.appendChild(o);
        });
        select.addEventListener('change', async () => {
          const val = select.value || null;
          try { await fetchJson(`/products/${item.id}`, {method:'PUT', body: JSON.stringify({competition_level: val})}); } catch(e) {}
          item.competition_level = val;
        });
        td.appendChild(select);
      } else if (col.type === 'number' && hasText(value)) {
        let num = parseFloat(String(value).replace(/[^0-9.-]+/g, ''));
        if (isNaN(num)) {
          td.textContent = '';
        } else {
          if (key === 'Item Sold' || key === 'Revenue($)' || key === 'Creator Number') {
            td.textContent = abbr(num);
          } else {
            td.textContent = num.toLocaleString();
          }
        }
      } else {
        td.textContent = hasText(value) ? value : '‚Äî';
      }
      tr.appendChild(td);
    });
    // Delete button
    const tdDel = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‚úñ';
    btn.title = 'Eliminar producto';
    btn.style.background = 'transparent';
    btn.style.border = 'none';
    btn.style.cursor = 'pointer';
    btn.style.color = 'red';
    btn.dataset.id = item.id;
    btn.onclick = () => {
      toast.info('¬øEliminar producto?', {actionText:'Eliminar', onAction: () => deleteProduct(item.id)});
    };
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });
  currentPageIds = products.map(p => String(p.id));
  updateResultsBadge(currentPageIds.length);
  if (window.refreshColumns) window.refreshColumns();
  if (window.applyColumnVisibility) window.applyColumnVisibility();
  updateMasterState();
  ecAutoFitColumns(gridRoot);
}

gridRoot.addEventListener('input',  e => { if (e.target.closest('td.ec-col-desire')) ecAutoFitColumns(gridRoot); });
gridRoot.addEventListener('change', e => { if (e.target.closest('td.ec-col-desire-mag, td.ec-col-awareness, td.ec-col-competition')) ecAutoFitColumns(gridRoot); });
window.addEventListener('resize', (() => { let t; return () => { clearTimeout(t); t = setTimeout(() => ecAutoFitColumns(gridRoot), 150); }; })());

function sortProducts(){
  if(!sortField) return;
  const field = sortField;
  const type = sortType;
  products.sort((a,b)=>{
    let va; let vb;
    if (field === 'id' || field === 'name' || field === 'category' || field === 'price' || field === 'image_url' || field === 'winner_score' || field === 'desire' || field === 'desireMagnitude' || field === 'awareness_level' || field === 'competition_level') {
      va = field === 'desireMagnitude' ? a.desire_magnitude : a[field];
      vb = field === 'desireMagnitude' ? b.desire_magnitude : b[field];
    } else if (metricKeys.includes(field)) {
      va = a.winner_score_breakdown && a.winner_score_breakdown.scores ? a.winner_score_breakdown.scores[field] : undefined;
      vb = b.winner_score_breakdown && b.winner_score_breakdown.scores ? b.winner_score_breakdown.scores[field] : undefined;
    } else {
      va = a.extras ? a.extras[field] : undefined;
      vb = b.extras ? b.extras[field] : undefined;
    }
    if (type === 'number') {
      const na = parseFloat(String(va).replace(/[^0-9.-]+/g, ''));
      const nb = parseFloat(String(vb).replace(/[^0-9.-]+/g, ''));
      if (isNaN(na) && isNaN(nb)) return 0;
      if (isNaN(na)) return sortDir * 1;
      if (isNaN(nb)) return sortDir * -1;
      return (na - nb) * sortDir;
    }
    const sa = (va || '').toString().toLowerCase();
    const sb = (vb || '').toString().toLowerCase();
    if (sa < sb) return -1 * sortDir;
    if (sa > sb) return 1 * sortDir;
    return 0;
  });
}

function sortBy(field, type) {
  if (sortField === field) {
    sortDir = -sortDir;
  } else {
    sortField = field;
    sortDir = 1;
    sortType = type;
  }
  sortProducts();
  renderTable();
}

document.getElementById('refreshBtn').onclick = fetchProducts;
window.onload = async () => {
  await ensureApiKey();
  await loadConfig();
  await fetchProducts();
  const tid = localStorage.getItem(IMPORT_TASK_LS_KEY);
  if(tid){
    toast.info('Reanudando IA post-import desde el √∫ltimo punto guardado‚Ä¶');
    pollImportStatus(tid);
  }
};
// Toggle config panel
document.getElementById('configBtn').onclick = async () => {
  await loadWeights();
  const cfg = document.getElementById('config');
  const wcard = document.getElementById('weightsCard');
  if(!cfg || !wcard || !window.modalManager) return;
  const btn = document.getElementById('configBtn');
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.setAttribute('role','dialog');
  modal.setAttribute('aria-modal','true');
  modal.innerHTML = '<header class="modal-header"><h3 id="configModalTitle">Configuraci√≥n</h3><button type="button" class="modal-close" aria-label="Cerrar">‚úï</button></header><div class="modal-body"></div>';
  modal.setAttribute('aria-labelledby','configModalTitle');
  const body = modal.querySelector('.modal-body');
  const cfgParent = cfg.parentElement;
  const wParent = wcard.parentElement;
  const cfgNext = cfg.nextSibling;
  const wNext = wcard.nextSibling;
  body.appendChild(cfg);
  body.appendChild(wcard);
  cfg.style.display = 'block';
  wcard.style.display = 'block';
  const handle = modalManager.open(modal, {returnFocus: btn, closeOnBackdrop:true, onClose: () => {
    cfg.style.display = 'none';
    wcard.style.display = 'none';
    cfgParent.insertBefore(cfg, cfgNext);
    wParent.insertBefore(wcard, wNext);
  }});
  modal.querySelector('.modal-close').addEventListener('click', () => handle.close());
  const first = modal.querySelector('input,select,textarea,button');
  if(first) first.focus();
};


// Handle file upload: clicking the upload button opens file chooser
const fileInputEl = document.getElementById('fileInput');
document.getElementById('uploadBtn').onclick = () => {
  fileInputEl.click();
};
// When a file is selected, automatically upload it
fileInputEl.onchange = async (ev) => {
  ev.preventDefault();
  const file = fileInputEl.files[0];
  if(!file) return;
  const formData = new FormData();
  formData.append('file', file);
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.style.opacity = '0.6';
  const loading = document.getElementById('loadingOverlay');
  if (loading) loading.style.display = 'flex';
  try {
    const data = await fetchJson('/upload', {method:'POST', body: formData});
    if (data.task_id) {
      localStorage.setItem(IMPORT_TASK_LS_KEY, data.task_id);
      pollImportStatus(data.task_id);
    } else if (data.ok) {
      await reloadTable();
      toast.success(`Importados ${data.imported || 0}`);
    } else if (data.error) {
      toast.error('Error: ' + data.error);
    }
  } catch(err){
    console.error(err);
    toast.error('Error al subir archivo');
  } finally {
    if (loading) loading.style.display = 'none';
    btn.disabled = false;
    btn.style.opacity = '';
    fileInputEl.value = '';
  }
};
// search feature
document.getElementById('searchBtn').onclick = () => {
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const tbody = document.querySelector('#productTable tbody');
  let visible = 0;
  Array.from(tbody.rows).forEach(row => {
    if (!term) {
      row.style.display = '';
      visible++;
      return;
    }
    const cells = Array.from(row.cells).map(td => td.textContent.toLowerCase());
    const match = cells.some(text => text.includes(term));
    row.style.display = match ? '' : 'none';
    if (match) visible++;
  });
  updateResultsBadge(visible);
};
const gptField = document.getElementById('gptPrompt');
const sendPromptBtn = document.getElementById('sendPrompt');

function autoGrow(el){
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

if(gptField){
  const saved = localStorage.getItem('lastGptPrompt');
  if(saved){
    gptField.value = saved;
    autoGrow(gptField);
  }
  gptField.addEventListener('input', () => {
    autoGrow(gptField);
    localStorage.setItem('lastGptPrompt', gptField.value);
  });
  gptField.addEventListener('keydown', e => {
    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      sendPromptHandler();
    }
  });
}

async function sendPromptHandler(){
  const prompt = gptField.value.trim();
  if(!prompt){ toast.info('Escribe una consulta'); return; }
  sendPromptBtn.disabled = true;
  try {
    const data = await fetchJson('/custom_gpt', {method:'POST', body: JSON.stringify({prompt})});
    const history = document.getElementById('history');
    if(history){
      const details = document.createElement('details');
      const summary = document.createElement('summary');
      const shortPrompt = prompt.length > 40 ? prompt.substring(0,37) + '...' : prompt;
      summary.textContent = shortPrompt;
      const pre = document.createElement('pre');
      pre.textContent = data.response || data.error;
      details.appendChild(summary);
      details.appendChild(pre);
      history.prepend(details);
    }
    toast.success('Consulta enviada');
    gptField.value = '';
    localStorage.removeItem('lastGptPrompt');
    autoGrow(gptField);
  } catch(err) {
    toast.error(err.message || 'Error al enviar');
  } finally {
    sendPromptBtn.disabled = false;
  }
}

sendPromptBtn.onclick = sendPromptHandler;
document.getElementById('darkToggle').onclick = () => {
  document.body.classList.toggle('dark');
};

// Helper to parse dates from various formats (YYYY-MM-DD or other)
function parseDate(value) {
  if (!value) return null;
  // Try direct Date parse
  const d = new Date(value);
  if (!isNaN(d)) return d;
  // Try splitting by non-digit
  const parts = String(value).match(/(\d{4})[\/-]?(\d{2})[\/-]?(\d{2})/);
  if (parts) {
    const y = parseInt(parts[1]);
    const m = parseInt(parts[2]) - 1;
    const day = parseInt(parts[3]);
    return new Date(y, m, day);
  }
  return null;
}


async function postApiKey(value){
  const resp = await fetch('/api/auth/set-key', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({api_key:value})
  });
  let data = {};
  try{ data = await resp.json(); } catch{}
  if(resp.ok && data.ok){
    savedApiKeyHash = await sha256(value);
    savedApiKeyLength = value.length;
    return {ok:true};
  }
  return {ok:false, error:data.error||'Error'};
}

async function showApiKeyModal(){
  return new Promise(res=>{
    const modal=document.createElement('div');
    modal.className='modal';
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-modal','true');
    modal.innerHTML='<header class="modal-header"><h3>API Key requerida</h3></header><div class="modal-body"><input type="password" id="modalApiKey" placeholder="API Key"><div class="api-error" style="color:red"></div><button id="modalSaveApiKey">Guardar y Verificar</button></div>';
    const handle=modalManager.open(modal,{closeOnBackdrop:false});
    const input=modal.querySelector('#modalApiKey');
    const errEl=modal.querySelector('.api-error');
    modal.querySelector('#modalSaveApiKey').onclick=async()=>{
      const val=input.value.trim();
      if(!val){ toast.error('La API Key no puede estar vac√≠a'); return; }
      const r=await postApiKey(val);
      if(r.ok){ handle.close(); res(true); }
      else{ errEl.textContent=r.error||'Error'; }
    };
    input.focus();
  });
}

async function ensureApiKey(){
  try{
    let resp=await fetch('/api/auth/has-key');
    let data=await resp.json();
    while(!data.has_key){
      await showApiKeyModal();
      resp=await fetch('/api/auth/has-key');
      data=await resp.json();
    }
  }catch(err){ console.error('Error checking API key',err); }
}

document.getElementById('toggleApiKey').onclick = () => {
  showApiKeyModal();
};

const apiKeyInput = document.getElementById('apiKey');
const saveApiKeyBtn = document.getElementById('saveApiKey');

apiKeyInput.addEventListener('input', async () => {
  const val = apiKeyInput.value.trim();
  let same = false;
  if (savedApiKeyHash && val) {
    const hash = await sha256(val);
    same = hash === savedApiKeyHash;
  }
  saveApiKeyBtn.disabled = !val || same;
});

saveApiKeyBtn.addEventListener('click', async () => {
  const value = apiKeyInput.value.trim();
  if (!value) { toast.error('La API Key no puede estar vac√≠a'); return; }
  const r = await postApiKey(value);
  if(!r.ok){ toast.error('No se pudo guardar la API Key'); return; }
  toast.success('API Key guardada');
  const masked = '‚Ä¢'.repeat(Math.max(savedApiKeyLength - 4, 0)) + value.slice(-4);
  apiKeyInput.value = masked;
  saveApiKeyBtn.disabled = true;
});

// Show overlay with larger image
function showOverlay(src){
  const overlay = document.getElementById('imgOverlay');
  const img = document.getElementById('overlayImg');
  img.src = src;
  overlay.style.display = 'flex';
}
// Hide overlay only when clicking outside the image
document.getElementById('imgOverlay').onclick = (e) => {
  if (e.target.id === 'imgOverlay') {
    document.getElementById('imgOverlay').style.display = 'none';
  }
};

// Delete a single product by ID
async function deleteProduct(id){
  try {
    if (typeof currentGroupFilter !== 'undefined' && currentGroupFilter > 0) {
      // remove only from current list
      const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentGroupFilter, ids: [id]})});
      if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); }
      // reload current list
      applyGroupFilter(currentGroupFilter);
    } else {
      const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: [id]})});
      if(data.error){ toast.error('Error al eliminar: '+data.error); }
      fetchProducts();
    }
  } catch(err){ console.error(err); toast.error('Error al eliminar'); }
}

// Delete selected products
document.getElementById('btnDelete').onclick = () => {
  const ids = Array.from(selection, Number);
  if(!ids.length){ toast.info('Selecciona al menos un producto para eliminar'); return; }
  toast.info('¬øEliminar los productos seleccionados?', {actionText:'Eliminar', onAction: async () => {
    try{
      if (typeof currentGroupFilter !== 'undefined' && currentGroupFilter > 0) {
        const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentGroupFilter, ids: ids})});
        if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); } else { toast.success('Eliminados del grupo: '+data.removed); }
        startProgress();
        applyGroupFilter(currentGroupFilter);
      } else {
        const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: ids})});
        if(data.error){ toast.error('Error al eliminar: '+data.error); } else { toast.success('Productos eliminados: '+data.deleted); }
        startProgress();
        fetchProducts();
      }
    }catch(err){ console.error(err); toast.error('Error al eliminar'); }
  }});
};

// Export selected products as CSV
document.getElementById('btnExport').onclick = async () => {
  const ids = Array.from(selection, Number);
  if(!ids.length){ toast.info('Selecciona productos para exportar'); return; }
  // Build query string
  const params = new URLSearchParams();
  params.set('ids', ids.join(','));
  // request export file
  try{
    const res = await fetch('/export?'+params.toString(), {method:'GET'});
    if(res.status !== 200){ toast.error('Error al exportar'); return; }
    const blob = await res.blob();
    // determine filename from header or default
    const disposition = res.headers.get('Content-Disposition');
    let filename = 'export.csv';
    if(disposition){
      const match = disposition.match(/filename="?([^\"]+)"?/);
      if(match) filename = match[1];
    }
    // progress feedback
    startProgress();
    // trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(err){ console.error(err); toast.error('Error al exportar'); }
};

function getSelectedProductIds(){ return Array.from(selection, Number); }
function setLoading(btn, s){ if(s){ btn.dataset.prev=btn.textContent; btn.textContent='Actualizando‚Ä¶'; } else { btn.textContent=btn.dataset.prev||btn.textContent; } }

// Generate Winner Score for selected or all products
document.getElementById('btnGenWinner').onclick = () => {
  const ids = getSelectedProductIds();
  const rows = ids.length ? allProducts.filter(p=>ids.includes(Number(p.id))) : products;
  const payloadProducts = rows.map(p=>{
    const metrics={};
    metricKeys.forEach(k=>{ if(p[k]!==undefined) metrics[k]=p[k]; });
    return {id:p.id, metrics};
  });
  if(payloadProducts.some(p=>Object.keys(p.metrics).length<metricKeys.length)){
    toast.info('Algunos productos tienen m√©tricas faltantes');
  }
  const body = ids.length ? {product_ids: ids} : {};
  body.products = payloadProducts;
  const btn = document.getElementById('btnGenWinner');
  btn.disabled = true; setLoading(btn, true);
  fetch('/api/winner-score/generate?debug=1', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  }).then(r=>r.json()).then(({processed=0, updated=0, diag})=>{
    if(!processed) toast.info('Nada que recalcular (0 seleccionados)');
    else if(updated>0) toast.success(`Winner Score recalculado: ${updated}/${processed} cambiaron`);
    else {
      if(diag && diag.sum_filtered===0){
        toast.info(`Recalculado ${processed}. No afect√≥: los pesos de m√©tricas presentes suman 0 ‚Üí fallback uniforme.`);
      } else {
        toast.info(`Recalculado ${processed}. El entero 0‚Äì100 no vari√≥ (redondeo).`);
      }
    }
    if(ids.length) reloadRows(ids); else reloadTable();
  }).catch(err=>{
    console.error(err);
    toast.error('No se pudo actualizar el Winner Score');
  }).finally(()=>{ btn.disabled=false; setLoading(btn,false); });
};

// -------- Group management --------
let currentGroupFilter = -1; // -1 indicates all products

async function loadLists() {
  try {
    const select = document.getElementById('groupSelect');
    if (!select) return;
    const lists = await groupsService.listGroups();
    select.innerHTML = '';

    const allOpt = document.createElement('option');
    allOpt.value = -1;
    allOpt.textContent = 'Todos';
    select.appendChild(allOpt);

    (lists || []).forEach(lst => {
      const opt = document.createElement('option');
      opt.value = lst.id;
      opt.textContent = lst.name;
      select.appendChild(opt);
    });

    select.value = currentGroupFilter.toString();
    select.onchange = (e) => {
      const id = parseInt(e.target.value);
      applyGroupFilter(id);
    };
  } catch(err) {
    console.error(err);
  }
}

window.loadLists = loadLists;
document.addEventListener('groups-updated', () => loadLists());

async function applyGroupFilter(id){
  if(id === -1){
    // load all products
    currentGroupFilter = -1;
    fetchProducts();
    // refresh lists to update active styling
    loadLists();
    return;
  }
  try{
    currentGroupFilter = id;
    const data = await fetchJson('/list/' + id);
    allProducts = data;
    products = [...allProducts];
    window.allProducts = allProducts;
    window.products = products;
    selection.clear();
    updateMasterState();
    renderTable();
    // refresh lists to highlight active group
    loadLists();
  } catch(err){ console.error(err); toast.error('Error al cargar lista'); }
}

// create list button
document.getElementById('createListBtn').onclick = async () => {
  const name = document.getElementById('newListName').value.trim();
  if(!name){ toast.info('Ingresa un nombre para el grupo'); return; }
  try{
    await groupsService.createGroup(name);
    document.getElementById('newListName').value = '';
    loadLists();
  }catch(err){ console.error(err); toast.error('Error al crear grupo'); }
};

// load lists on page load
window.addEventListener('DOMContentLoaded', () => {
  loadLists();
});

// trends button & analytics rendering
let trendsData = null;
let currentMetric = 'revenue';
document.getElementById('trendsBtn').onclick = async () => {
  const cont = document.getElementById('trends');
  if (cont.style.display === 'block') {
    cont.style.display = 'none';
    cont.innerHTML = '';
    document.getElementById('chartContainer').style.display = 'none';
    return;
  }
  cont.style.display = 'block';
  cont.innerHTML = '<h3>Tendencias</h3>';
  await loadTrends();
};
document.getElementById('applyTrendFilters').onclick = () => loadTrends();
document.getElementById('metricSelect').onchange = e => {
  currentMetric = e.target.value;
  renderTrends();
};

async function loadTrends(){
  const cont = document.getElementById('trends');
  const start = document.getElementById('trendStart').value;
  const end = document.getElementById('trendEnd').value;
  let url = '/trends';
  const params=[];
  if(start) params.push('start='+encodeURIComponent(start));
  if(end) params.push('end='+encodeURIComponent(end));
  if(params.length) url += '?' + params.join('&');
  const data = await fetchJson(url);
  if(data.error){ cont.textContent = 'Error al cargar tendencias: '+data.error; return; }
  trendsData = data;
  trendingWords = (data.keywords || []).map(([w])=>w.toLowerCase());
  let html = '<h3>Tendencias</h3>';
  if(data.top_products && data.top_products.length){
    html += '<strong>Top productos por Winner Score:</strong><ol>';
        data.top_products.forEach(item=>{ const sc = Math.round(item.winner_score || 0); html += `<li>${item.name} (Winner Score: ${sc.toLocaleString(undefined,{maximumFractionDigits:0})})</li>`; });
    html += '</ol>';
  }
  cont.innerHTML = html;
  renderTrends();
}

function renderTrends(){
  if(!trendsData) return;
  const chartDiv = document.getElementById('chartContainer');
  chartDiv.style.display='block';
  const k = trendsData.kpis || {};
  document.getElementById('kpiPanel').innerHTML = `
    <div><strong>Ingresos totales:</strong> ${k.total_revenue ? k.total_revenue.toFixed(2) : 0}</div>
    <div><strong>Unidades totales:</strong> ${k.total_units || 0}</div>
    <div><strong>Precio medio:</strong> ${k.avg_price ? k.avg_price.toFixed(2) : 0}</div>
    <div><strong>Categor√≠a top:</strong> ${k.top_category || '-'}</div>
    <div><strong>Producto top:</strong> ${k.top_product || '-'}</div>`;
  const tooltip = document.getElementById('chartTooltip');
  const drawHorizontal = (canvasId, entries, color, axisLabel) => {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const padL=120,padT=20,padB=40,barH=28,gap=12;
    const width = chartDiv.clientWidth - 40;
    canvas.width = width;
    canvas.height = padT + padB + entries.length*(barH+gap);
    ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const maxVal = Math.max(...entries.map(e=>e.value),0);
    ctx.font='14px sans-serif'; ctx.textBaseline='middle';
    const rects=[];
    entries.forEach((e,i)=>{
      const y=padT+i*(barH+gap);
      const len=maxVal?(e.value/maxVal)*(canvas.width-padL-40):0;
      ctx.fillStyle=color; ctx.fillRect(padL,y,len,barH);
      ctx.fillStyle='#000'; ctx.fillText(e.value,padL+len+5,y+barH/2);
      ctx.fillText(e.label,10,y+barH/2);
      rects.push({x:padL,y:y,w:len,h:barH,data:e});
    });
    ctx.strokeStyle='#666'; ctx.beginPath();
    ctx.moveTo(padL,padT-10); ctx.lineTo(padL,canvas.height-padB); ctx.lineTo(canvas.width-20,canvas.height-padB); ctx.stroke();
    ctx.font='16px sans-serif'; ctx.fillStyle='#000'; if(axisLabel) ctx.fillText(axisLabel,canvas.width/2,canvas.height-10);
    canvas.onmousemove=ev=>{
      const r=canvas.getBoundingClientRect(); const mx=ev.clientX-r.left,my=ev.clientY-r.top;
      const hit=rects.find(b=>mx>=b.x && mx<=b.x+b.w && my>=b.y && my<=b.y+b.h);
      if(hit){ tooltip.style.display='block'; tooltip.textContent=hit.data.tooltip||`${hit.data.label}: ${hit.data.value}`; tooltip.style.left=ev.pageX+10+'px'; tooltip.style.top=ev.pageY+10+'px'; }
      else tooltip.style.display='none'; };
    canvas.onmouseleave=()=>tooltip.style.display='none';
  };
  const drawScatter = (canvasId, points, color, xLabel, yLabel) => {
    const canvas=document.getElementById(canvasId); const ctx=canvas.getContext('2d');
    const padL=60,padB=40,padT=20,width=chartDiv.clientWidth-40,height=400;
    canvas.width=width; canvas.height=height;
    ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,width,height);
    const maxX=Math.max(...points.map(p=>p.x),0), maxY=Math.max(...points.map(p=>p.y),0), maxR=Math.max(...points.map(p=>p.r||0),0);
    const pts=[];
    points.forEach(p=>{ const x=padL+(maxX?(p.x/maxX)*(width-padL-20):0); const y=height-padB-(maxY?(p.y/maxY)*(height-padT-padB):0); const r=p.r?Math.max(4,(p.r/maxR)*20):6; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); pts.push({x,y,r,data:p});});
    ctx.strokeStyle='#666'; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,height-padB); ctx.lineTo(width-20,height-padB); ctx.stroke();
    ctx.font='16px sans-serif'; ctx.fillStyle='#000'; ctx.fillText(xLabel,width/2,height-10); ctx.save(); ctx.translate(20,height/2); ctx.rotate(-Math.PI/2); ctx.fillText(yLabel,0,0); ctx.restore();
    canvas.onmousemove=ev=>{ const r=canvas.getBoundingClientRect(); const mx=ev.clientX-r.left,my=ev.clientY-r.top; const hit=pts.find(p=>Math.hypot(mx-p.x,my-p.y)<=p.r); if(hit){ const d=hit.data; tooltip.style.display='block'; tooltip.innerHTML=`${d.label||''}<br/>Ingresos: ${d.revenue?.toFixed?d.revenue.toFixed(2):d.y.toFixed(2)}<br/>Unidades: ${d.units||''}<br/>Rating: ${d.rating||''}`; tooltip.style.left=ev.pageX+10+'px'; tooltip.style.top=ev.pageY+10+'px'; } else tooltip.style.display='none'; };
    canvas.onmouseleave=()=>tooltip.style.display='none';
  };
  const metricLabel = currentMetric==='units'?'Unidades medias':currentMetric==='avg_price'?'Precio medio':'Ingresos medios';
  const catPts=(trendsData.category_compare||[]).map(c=>({x:c.products,y:currentMetric==='units'?c.avg_units:currentMetric==='avg_price'?c.avg_price:c.avg_revenue,label:c.category,revenue:c.total_revenue,units:c.total_units,rating:c.avg_rating}));
  drawScatter('catCompareCanvas',catPts,'#26a69a','Productos listados',metricLabel);
  renderCategorySummary();
  drawHorizontal('catRevenueGrowthCanvas',(trendsData.cat_revenue_growth||[]).map(e=>({label:e[0],value:e[1]})),'#42a5f5','Crecimiento ingresos');
  drawHorizontal('catUnitGrowthCanvas',(trendsData.cat_units_growth||[]).map(e=>({label:e[0],value:e[1]})),'#66bb6a','Crecimiento unidades');
  drawHorizontal('catRevPerUnitCanvas',(trendsData.cat_rev_per_unit||[]).map(e=>({label:e[0],value:e[1]})),'#ffca28','Ingresos/unidad');
  drawHorizontal('keywordTrendCanvas',(trendsData.keywords||[]).map(e=>({label:e[0],value:e[1]})),'#29b6f6','Frecuencia');
  drawHorizontal('brandTrendCanvas',(trendsData.brands||[]).map(e=>({label:e[0],value:e[1]})),'#ab47bc','Frecuencia');
  drawScatter('ratingRevenueCanvas',trendsData.scatter_rating_revenue||[],'#ef5350','Rating','Ingresos');
  drawScatter('priceRevenueCanvas',trendsData.scatter_price_revenue||[],'#7e57c2','Precio promedio','Ingresos');
  renderTable();
}

let catSort={key:'category',asc:true};
function renderCategorySummary(){
  const table=document.getElementById('categorySummaryTable');
  if(!table) return;
  let rows=[...(trendsData.category_summary||[])];
  rows.sort((a,b)=>{const k=catSort.key;const va=a[k],vb=b[k];if(typeof va==='string') return catSort.asc?va.localeCompare(vb):vb.localeCompare(va);return catSort.asc?va-vb:vb-va;});
  let head=`<thead><tr><th data-key="category">Categor√≠a</th><th data-key="products">#Productos</th><th data-key="total_units">Unidades totales</th><th data-key="total_revenue">Ingresos totales</th><th data-key="avg_price">Precio promedio</th><th data-key="avg_rating">Rating promedio</th></tr></thead>`;
  let body='<tbody>';
  rows.forEach(r=>{body+=`<tr><td>${r.category}</td><td>${r.products}</td><td>${r.total_units.toFixed(0)}</td><td>${r.total_revenue.toFixed(2)}</td><td>${r.avg_price.toFixed(2)}</td><td>${r.avg_rating.toFixed(2)}</td></tr>`;});
  body+='</tbody>'; table.innerHTML=head+body;
  table.querySelectorAll('th').forEach(th=>{th.style.cursor='pointer';th.onclick=()=>{const key=th.dataset.key;if(catSort.key===key) catSort.asc=!catSort.asc; else {catSort.key=key;catSort.asc=true;} renderCategorySummary();};});
}

window.renderTable = renderTable;
window.startProgress = startProgress;
window.parseDate = parseDate;
</script>
<script type="module" src="/static/js/completar-ia.js"></script>
<div id="chartTooltip" style="position:absolute; background:#fff; border:1px solid #333; padding:4px; font-size:12px; border-radius:4px; pointer-events:none; display:none; z-index:2000;"></div>
<script src="/static/js/filters.js"></script>
</body>
</html>
