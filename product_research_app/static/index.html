<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Product Research Copilot</title>
<link rel="stylesheet" href="/static/css/app.css">
<link rel="stylesheet" href="/static/css/toast.css">
<style>
/* Basic layout */
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, sans-serif; color:#222; background: linear-gradient(to bottom, #f8fbff, #e9f0ff); }
body.dark { background: #1a1b2e; color:#eaeaea; }
header { padding:20px; text-align:center; background: linear-gradient(90deg, #0062ff, #00c8ff); color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
body.dark header { background: linear-gradient(90deg, #2e2e78, #6547a6); }
.container { max-width: 1200px; margin: 0 auto; padding: 10px; }
.card { background:#fff; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); padding:15px; margin-bottom:15px; }
body.dark .card { background:#262a51; box-shadow:0 0 10px rgba(0,0,0,0.4); }
/* Controls */
#controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
button { padding:8px 14px; border:none; border-radius:4px; cursor:pointer; background: linear-gradient(90deg,#0062ff,#00c8ff); color:#fff; font-weight:600; box-shadow:0 3px 5px rgba(0,0,0,0.2); transition:opacity 0.2s; }
button:hover { opacity:0.85; }
body.dark button { background: linear-gradient(90deg,#3a3cad,#7a53d6); color:#fff; }
/* Chip style for filter toggle */
#btnFilters { background:#e0f0ff; border:1px solid #0077cc; color:#0077cc; padding:6px 10px; border-radius:16px; font-size:14px; }
body.dark #btnFilters { background:#2a2d5c; border-color:#7a53d6; color:#a9a9ff; }
select, input[type="text"], input[type="password"] { padding:6px; border-radius:4px; border:1px solid #ccc; }
body.dark select, body.dark input[type="text"], body.dark input[type="password"] { background:#1f2344; color:#eaeaea; border-color:#444; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; border:1px solid #ccc; }
body.dark th, body.dark td { border-color:#444; }
tbody tr:nth-child(even) { background:#f2f6ff; }
body.dark tbody tr:nth-child(even) { background:#2a2d5c; }
body.dark tbody tr:nth-child(odd) { background:#25285a; }
tbody tr:hover {
  box-shadow: 0 0 6px rgba(0,0,0,0.2);
  transform: translateY(-2px);
  transition: box-shadow 0.2s, transform 0.2s;
}
/* History & Details */
#history details { margin-bottom:8px; }
details summary { cursor:pointer; font-weight:600; color:#0062ff; }
body.dark details summary { color:#80b3ff; }
pre { white-space:pre-wrap; background:#f5f7ff; padding:8px; border-radius:4px; }
body.dark pre { background:#2e315f; }
/* Weight slider styling */
.weight-slider {
  width:120px;
  accent-color:#0077cc;
}
body.dark .weight-slider {
  accent-color:#7a53d6;
}
</style>
</head>
<body class="dark">
<div id="topBar">
  <header style="padding:8px 15px; display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:8px;">
      <h1 style="margin:0; font-size:1.4rem;">Ecom Testing App</h1>
      <p style="margin:0;font-size:12px; opacity:0.8;">By El Tito ü§ô</p>
    </div>
    <div style="flex:1; display:flex; justify-content:flex-end; gap:8px; align-items:center;">
      <input type="file" id="fileInput" style="display:none;" />
      <button id="uploadBtn" title="Subir archivo">üì§</button>
      <button id="refreshBtn" title="Actualizar lista">üîÑ</button>
      <button id="trendsBtn" title="Ver tendencias">üìä</button>
      <button id="darkToggle" title="Modo oscuro">üåô</button>
      <button id="configBtn" title="Configuraci√≥n avanzada">‚öôÔ∏è</button>
    </div>
  </header>
</div>
<!-- Unified control bar replacing page and table toolbars -->
<div id="controlBar" role="toolbar" aria-label="Barra de controles" tabindex="0">
  <div class="left">
    <input type="text" id="searchInput" placeholder="Buscar producto o palabra clave..." />
    <button id="searchBtn">Buscar</button>
    <button id="btnFilters">Filtros</button>
    <div id="activeFilterChips"></div>
    <div id="listMeta">0 resultados</div>
  </div>
  <div class="right">
    <button id="legendBtn" class="legend-btn" aria-label="Informaci√≥n de columnas">‚ÑπÔ∏è</button>
    <span id="selCount" aria-live="polite"></span>
    <select id="groupSelect" aria-label="Seleccionar grupo"></select>
    <button id="btnAddToGroup" aria-label="A√±adir a grupo" disabled>A√±adir a grupo</button>
    <button id="sendPrompt" type="button" aria-haspopup="dialog" aria-controls="promptDrawer">Consulta a GPT</button>
    <button id="btnColumns">Columnas</button>
    <button id="btnExport" disabled>Exportar</button>
    <button id="btnDelete" disabled>Eliminar</button>
  </div>
</div>
<input type="checkbox" id="selectAll" aria-label="Seleccionar todo" style="display:none;">
<div id="config" style="display:none;">
  <label>API Key: <input type="password" id="apiKey" /></label>
  <button id="toggleApiKey" style="display:none;">Cambiar API Key</button>
  <label>Modelo:
    <select id="modelSelect">
      <option value="gpt-4o">GPT-4o</option>
      <option value="gpt-4">GPT-4</option>
      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
    </select>
  </label>
  <button id="saveConfig">Guardar configuraci√≥n</button>
</div>
<div id="weightsCard" class="card" style="display:none; max-width:420px;">
  <strong>Ponderaciones Winner Score</strong>
  <div id="weightsContainer" style="margin-top:8px; display:flex; flex-direction:column; gap:6px;"></div>
  <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px;">
    <button id="autoWeightsGpt">Ajustar pesos con IA</button>
    <button id="autoWeightsStat">Ajustar estad√≠stico</button>
    <button id="saveWeights">Guardar</button>
  </div>
</div>
<!-- Drawer for custom GPT prompts -->
<div id="promptDrawer" class="drawer right hidden" role="dialog" aria-modal="true">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>Consulta a GPT</h3>
    <button id="closePrompt">√ó</button>
  </div>
  <textarea id="customPrompt" rows="3" placeholder="Escribe tu consulta personalizada a GPT"></textarea>
  <div id="history" style="margin-top:10px;"></div>
</div>
<div id="trends" class="card" style="display:none;"></div>
<!-- Chart container for trends -->
<div id="chartContainer" class="card" style="display:none;">
  <div id="trendControls" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-bottom:20px;">
    <div><label>Desde: <input type="date" id="trendStart"></label></div>
    <div><label>Hasta: <input type="date" id="trendEnd"></label></div>
    <div><label>M√©trica:
      <select id="metricSelect">
        <option value="revenue">Ingresos</option>
        <option value="units">Unidades</option>
        <option value="avg_price">Avg. Unit Price</option>
      </select>
    </label></div>
    <button id="applyTrendFilters">Aplicar</button>
  </div>
  <div id="kpiPanel" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:space-around; margin-bottom:20px;"></div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Comparativo por categor√≠a</h3>
    <canvas id="catCompareCanvas" style="width:100%; height:400px;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Resumen por categor√≠a</h3>
    <table id="categorySummaryTable"></table>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Top categor√≠as por crecimiento en ingresos</h3>
    <canvas id="catRevenueGrowthCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Top categor√≠as por crecimiento en unidades</h3>
    <canvas id="catUnitGrowthCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Ingresos/unidades por categor√≠a</h3>
    <canvas id="catRevPerUnitCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Palabras clave destacadas</h3>
    <canvas id="keywordTrendCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Marcas m√°s repetidas</h3>
    <canvas id="brandTrendCanvas" style="width:100%;"></canvas>
  </div>
  <div style="width:100%; margin-bottom:20px;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Rating vs Ingresos</h3>
    <canvas id="ratingRevenueCanvas" style="width:100%; height:400px;"></canvas>
  </div>
  <div style="width:100%;">
    <h3 style="margin-bottom:8px; font-size:18px; text-align:center;">Precio promedio vs Ingresos</h3>
    <canvas id="priceRevenueCanvas" style="width:100%; height:400px;"></canvas>
  </div>
</div>

<table id="productTable">
  <thead class="sticky-thead">
    <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>
<div id="legendPop" class="popover hidden">
  <div>‚Ä¢ Fila roja: duplicado</div>
  <div>‚Ä¢ üî• x1‚Äìx5: tendencia en el nombre</div>
</div>
<div id="columnsPanel" class="popover hidden"></div>

<!-- Overlay for viewing images in larger size -->
<div id="imgOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
  <img id="overlayImg" src="" style="max-width:90%; max-height:90%; box-shadow:0 0 10px #000; border-radius:8px;" />
</div>
<!-- Progress bar for micro interactions -->
<div id="progressBar" style="position:fixed; top:0; left:0; height:3px; background:#0077cc; width:0%; display:none; z-index:3000;"></div>
<!-- Loading overlay shown during file uploads -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); color:#fff; font-size:20px; align-items:center; justify-content:center; z-index:2000;">
  <div style="text-align:center;">
    <div class="spinner" style="margin-bottom:10px; width:40px; height:40px; border:5px solid #f3f3f3; border-top:5px solid #0062ff; border-radius:50%; animation: spin 1s linear infinite;"></div>
    <div>Cargando archivo...</div>
  </div>
</div>
<div id="filtersDrawer" class="drawer right hidden">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>Filtros</h3>
    <button id="closeFilters">√ó</button>
  </div>
  <div style="display:flex; flex-direction:column; gap:8px;">
    <label>Precio m√≠n<br><input type="number" id="filterPriceMin"></label>
    <label>Precio m√°x<br><input type="number" id="filterPriceMax"></label>
    <label>Fecha desde<br><input type="date" id="filterDateMin"></label>
    <label>Fecha hasta<br><input type="date" id="filterDateMax"></label>
    <label>Rating m√≠n<br><input type="number" id="filterRatingMin" step="0.1" min="0" max="5"></label>
    <label>Categor√≠a<br><input type="text" id="filterCategory"></label>
  </div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button id="applyFilters" style="flex:1;">Aplicar</button>
    <button id="clearFilters" style="flex:1;">Limpiar</button>
  </div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script src="/static/js/toast.js"></script>
<script src="/static/js/table.js"></script>
<script src="/static/js/columns.js"></script>
<script type="module">
import { fetchJson } from "/static/js/net.js";
window.addEventListener('beforeunload', () => navigator.sendBeacon('/shutdown'));
// Global arrays to hold all products and the current filtered list
let allProducts = [];
let products = [];
let sortField = null;
let sortDir = 1;
window.allProducts = allProducts;
window.products = products;
const columns = [
  { key: 'id', label: 'ID', type: 'number' },
  { key: 'image_url', label: 'Imagen', type: 'image' },
  { key: 'name', label: 'Nombre', type: 'string' },
  { key: 'category', label: 'Categor√≠a', type: 'string' },
  { key: 'price', label: 'Precio', type: 'number' },
  { key: 'Product Rating', label: 'Rating', type: 'number' },
  { key: 'Item Sold', label: 'Unidades Vendidas', type: 'number' },
  { key: 'Revenue($)', label: 'Ingresos', type: 'number' },
  { key: 'Creator Conversion Ratio', label: 'Tasa Conversi√≥n', type: 'string' },
  { key: 'Launch Date', label: 'Fecha Lanzamiento', type: 'string' },
  { key: 'Date Range', label: 'Rango Fechas', type: 'string' },
  { key: 'magnitud_deseo', label: 'Magnitud deseo', type: 'number' },
  { key: 'nivel_consciencia', label: 'Nivel consciencia', type: 'number' },
  { key: 'saturacion_mercado', label: 'Saturaci√≥n mercado', type: 'number' },
  { key: 'facilidad_anuncio', label: 'Facilidad anuncio', type: 'number' },
  { key: 'facilidad_logistica', label: 'Facilidad log√≠stica', type: 'number' },
  { key: 'escalabilidad', label: 'Escalabilidad', type: 'number' },
  { key: 'engagement_shareability', label: 'Engagement/shareability', type: 'number' },
  { key: 'durabilidad_recurrencia', label: 'Durabilidad/recurrencia', type: 'number' },
  { key: 'winner_score_v2_pct', label: 'Winner Score', type: 'number' },
];

let trendingWords = [];

const weightFields = [
  'magnitud_deseo',
  'nivel_consciencia',
  'saturacion_mercado',
  'facilidad_anuncio',
  'facilidad_logistica',
  'escalabilidad',
  'engagement_shareability',
  'durabilidad_recurrencia'
];

function renderWeights(weights){
  const container = document.getElementById('weightsContainer');
  if (!container) return;
  container.innerHTML = '';
  weightFields.forEach(key => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '6px';
    const label = document.createElement('label');
    label.textContent = key;
    label.style.minWidth = '160px';
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.01';
    input.min = '0';
    input.max = '1';
    input.value = (weights[key] ?? 0).toFixed(3);
    input.dataset.key = key;
    input.className = 'weight-slider';
    row.appendChild(label);
    row.appendChild(input);
    container.appendChild(row);
  });
}

async function loadConfig() {
  try {
    const cfg = await fetchJson('/config');
    if (cfg.model) {
      document.getElementById('modelSelect').value = cfg.model;
    }
    if (cfg.has_api_key) {
      const apiInput = document.getElementById('apiKey');
      apiInput.style.display = 'none';
      document.getElementById('toggleApiKey').style.display = 'inline-block';
    }
    renderWeights(cfg.scoring_v2_weights || {});
  } catch (err) {
    console.error('Error loading config', err);
  }
}

// Microinteraction progress bar
function startProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.display = 'block';
  bar.style.width = '0%';
  let progress = 0;
  const interval = setInterval(() => {
    progress += 10;
    bar.style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        bar.style.display = 'none';
        bar.style.width = '0%';
      }, 200);
    }
  }, 30);
}

// helper to highlight trending keywords
function isTrending(name) {
  if (!name) return false;
  const words = name.toLowerCase().split(/[^a-z0-9√°√©√≠√≥√∫√º√±]+/);
  return words.some(w => trendingWords.includes(w));
}

async function fetchProducts() {
  const data = await fetchJson('/products');
  // keep a copy of all products for filtering
  allProducts = data;
  products = [...allProducts];
  window.allProducts = allProducts;
  window.products = products;
  selection.clear();
  updateMasterState();
  renderTable();
}

function renderTable() {
  const headerRow = document.getElementById('headerRow');
  const tbody = document.querySelector('#productTable tbody');
  // Build header if empty
  if (!headerRow.hasChildNodes()) {
    // Add select column header (no label)
    const thSel = document.createElement('th');
    thSel.style.textAlign = 'center';
    thSel.setAttribute('scope', 'col');
    thSel.setAttribute('aria-label', 'Seleccionar todas las filas');
    const master = document.getElementById('selectAll');
    if (master) {
      master.style.display = '';
      master.title = 'Seleccionar todas las filas visibles';
      thSel.appendChild(master);
    }
    headerRow.appendChild(thSel);
    // Add dynamic columns
    columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col.label;
      th.style.cursor = 'pointer';
      th.setAttribute('data-key', col.key);
      th.onclick = () => sortBy(col.key, col.type);
      headerRow.appendChild(th);
    });
    // Add delete column header
    const thDel = document.createElement('th');
    headerRow.appendChild(thDel);
  }
  // Clear body
  tbody.innerHTML = '';
  // Render rows
    products.forEach(item => {
    const tr = document.createElement('tr');
    // mark duplicate rows
    if (item.extras && item.extras['duplicate_of']) {
      tr.style.backgroundColor = 'rgba(255, 230, 230, 0.5)';
    }
    // trending highlighting is now indicated by fire emojis instead of row outline
    // Selection checkbox
    const tdSel = document.createElement('td');
    tdSel.style.textAlign = 'center';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.classList.add('rowCheck');
    const rowId = String(item.id);
    cb.dataset.id = rowId;
    cb.checked = selection.has(rowId);
    tr.classList.toggle('selected', cb.checked);
    cb.addEventListener('change', () => {
      const id = cb.dataset.id;
      if (cb.checked) selection.add(id); else selection.delete(id);
      tr.classList.toggle('selected', cb.checked);
      updateMasterState();
    });
    tdSel.appendChild(cb);
    tr.appendChild(tdSel);
    columns.forEach(col => {
      const td = document.createElement('td');
      const key = col.key;
      td.setAttribute('data-key', key);
      let value = '';
      if (weightFields.includes(key)) {
        value = item.winner_score_v2_breakdown && item.winner_score_v2_breakdown.scores ? item.winner_score_v2_breakdown.scores[key] : '';
        if (item.winner_score_v2_breakdown && item.winner_score_v2_breakdown.justifications) {
          const j = item.winner_score_v2_breakdown.justifications[key];
          if (j) td.title = 'Justificaci√≥n: ' + j;
        }
      } else if (['id','name','category','price','image_url','winner_score_v2_pct'].includes(key)) {
        value = item[key];
      } else {
        value = item.extras ? item.extras[key] : '';
      }
      if (key === 'winner_score_v2_pct') {
        const sc = parseFloat(value);
        if (!isNaN(sc)) {
          td.innerHTML = '<span class="' + winnerScoreClass(sc) + '">' + Math.round(sc) + '</span>';
          if (item.winner_score_v2_breakdown && item.winner_score_v2_breakdown.justifications) {
            const j = item.winner_score_v2_breakdown.justifications;
            const tooltip = Object.entries(j).map(([k,v])=>`${k}: ${v}`).join('\n');
            td.title = tooltip;
          }
        }
      } else if (key === 'image_url' && value) {
        const img = document.createElement('img');
        img.src = value;
        // Increase the preview size for better visibility
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        // Show larger image on click
        img.style.cursor = 'pointer';
        img.onclick = () => {
          showOverlay(value);
        };
        td.appendChild(img);
      } else if (key === 'name' && value) {
        const fireText = firesFor(item.trendingScore);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = value + (fireText ? ' ' : '');
        td.appendChild(nameSpan);
        if (fireText) {
          const fireSpan = document.createElement('span');
          fireSpan.className = 'fires';
          fireSpan.textContent = fireText;
          td.appendChild(fireSpan);
        }
        // If Kalodata URL exists, add copy link button
        const kal = item.extras && item.extras['KalodataUrl'];
        if (kal) {
          const btnCopy = document.createElement('button');
          btnCopy.textContent = 'üìã';
          btnCopy.title = 'Copiar link Kalodata';
          btnCopy.style.marginLeft = '5px';
          btnCopy.style.padding = '2px 6px';
          btnCopy.style.fontSize = '12px';
          btnCopy.onclick = () => {
            navigator.clipboard.writeText(kal).then(() => {
              toast.success('Link copiado al portapapeles');
            });
          };
          td.appendChild(btnCopy);
        }
      } else if (col.type === 'number' && value !== null && value !== undefined && value !== '') {
        let num = parseFloat(String(value).replace(/[^0-9.-]+/g, ''));
        if (isNaN(num)) {
          td.textContent = '';
        } else {
          if (key === 'Item Sold' || key === 'Revenue($)' || key === 'Creator Number') {
            td.textContent = abbr(num);
          } else {
            td.textContent = num.toLocaleString();
          }
        }
      } else {
        td.textContent = value || '';
      }
      tr.appendChild(td);
    });
    // Delete button
    const tdDel = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‚úñ';
    btn.title = 'Eliminar producto';
    btn.style.background = 'transparent';
    btn.style.border = 'none';
    btn.style.cursor = 'pointer';
    btn.style.color = 'red';
    btn.dataset.id = item.id;
    btn.onclick = () => {
      toast.info('¬øEliminar producto?', {actionText:'Eliminar', onAction: () => deleteProduct(item.id)});
    };
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });
  currentPageIds = products.map(p => String(p.id));
  document.getElementById('listMeta').textContent = `${currentPageIds.length} resultados`;
  if (window.refreshColumns) window.refreshColumns();
  if (window.applyColumnVisibility) window.applyColumnVisibility();
  updateMasterState();
}

function sortBy(field, type) {
  if (sortField === field) {
    sortDir = -sortDir;
  } else {
    sortField = field;
    sortDir = 1;
  }
  products.sort((a, b) => {
    let va;
    let vb;
    if (field === 'id' || field === 'name' || field === 'category' || field === 'price' || field === 'image_url' || field === 'winner_score_v2_pct') {
      va = a[field];
      vb = b[field];
    } else if (weightFields.includes(field)) {
      va = a.winner_score_v2_breakdown && a.winner_score_v2_breakdown.scores ? a.winner_score_v2_breakdown.scores[field] : undefined;
      vb = b.winner_score_v2_breakdown && b.winner_score_v2_breakdown.scores ? b.winner_score_v2_breakdown.scores[field] : undefined;
    } else {
      va = a.extras ? a.extras[field] : undefined;
      vb = b.extras ? b.extras[field] : undefined;
    }
    if (type === 'number') {
      const na = parseFloat(String(va).replace(/[^0-9.-]+/g, ''));
      const nb = parseFloat(String(vb).replace(/[^0-9.-]+/g, ''));
      if (isNaN(na) && isNaN(nb)) return 0;
      if (isNaN(na)) return sortDir * 1;
      if (isNaN(nb)) return sortDir * -1;
      return (na - nb) * sortDir;
    }
    // default string comparison
    const sa = (va || '').toString().toLowerCase();
    const sb = (vb || '').toString().toLowerCase();
    if (sa < sb) return -1 * sortDir;
    if (sa > sb) return 1 * sortDir;
    return 0;
  });
  renderTable();
}

document.getElementById('refreshBtn').onclick = fetchProducts;
window.onload = () => { loadConfig(); fetchProducts(); };
// Toggle config panel
document.getElementById('configBtn').onclick = () => {
  const cfg = document.getElementById('config');
  const wcard = document.getElementById('weightsCard');
  if (!cfg || !wcard) return;
  const show = (cfg.style.display === 'none' || cfg.style.display === '') ? 'block' : 'none';
  cfg.style.display = show;
  wcard.style.display = show;
};

async function saveWeightsConfig(weights){
  await fetchJson('/setconfig',{method:'POST', body: JSON.stringify({scoring_v2_weights: weights})});
}

async function saveWeights(){
  const inputs = document.querySelectorAll('#weightsContainer input');
  const weights = {};
  let total = 0;
  inputs.forEach(inp => {
    const v = parseFloat(inp.value) || 0;
    weights[inp.dataset.key] = v;
    total += v;
  });
  if (total <= 0){ toast.error('Pesos inv√°lidos'); return; }
  Object.keys(weights).forEach(k => weights[k] = weights[k] / total);
  await saveWeightsConfig(weights);
  toast.success('Pesos guardados');
}

document.getElementById('saveWeights').onclick = saveWeights;
document.getElementById('autoWeightsGpt').onclick = async () => {
  const res = await fetchJson('/scoring/v2/auto-weights-gpt',{method:'POST'});
  if(res.error) { toast.error(res.error); return; }
  const msg = 'Pesos sugeridos por IA:\n'
    + JSON.stringify(res.weights, null, 2) + '\n'
    + (res.justification ? ('Justificaci√≥n: '+res.justification+'\n') : '')
    + '¬øAplicarlos?';
  if(confirm(msg)){
    renderWeights(res.weights);
    await saveWeightsConfig(res.weights);
    toast.success('Pesos guardados');
  }
};
document.getElementById('autoWeightsStat').onclick = async () => {
  const res = await fetchJson('/scoring/v2/auto-weights-stat', {method:'POST'});
  if (res.error) {
    toast.error(res.error);
    return;
  }
  const msg = 'Pesos sugeridos por correlaci√≥n:\n' +
              JSON.stringify(res.weights, null, 2) +
              '\n¬øAplicarlos?';
  if (confirm(msg)) {
    renderWeights(res.weights);
    await saveWeightsConfig(res.weights);
    toast.success('Pesos guardados (estad√≠stico)');
  }
};
// Handle file upload: clicking the upload button opens file chooser
const fileInputEl = document.getElementById('fileInput');
document.getElementById('uploadBtn').onclick = () => {
  fileInputEl.click();
};
// When a file is selected, automatically upload it
fileInputEl.onchange = async () => {
  const file = fileInputEl.files[0];
  if(!file) return;
  const formData = new FormData();
  formData.append('file', file);
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.style.opacity = '0.6';
  const loading = document.getElementById('loadingOverlay');
  if (loading) loading.style.display = 'flex';
  try {
    const data = await fetchJson('/upload', {method:'POST', body: formData});
    if(data.error){
      toast.error('Error: '+data.error);
    } else {
      let msg = '';
      if(data.inserted !== undefined) {
        msg += 'Productos importados: '+data.inserted+'\n';
      }
      if(data.uploaded_image){
        if(data.inserted && data.inserted > 0) {
          msg += 'Se proces√≥ la imagen y se a√±adieron productos.';
        } else {
          msg += 'Imagen subida. No se a√±adieron productos autom√°ticamente.';
        }
      }
      toast.success(msg || 'Archivo procesado');
      fetchProducts();
    }
  } catch(err){
    console.error(err);
    toast.error('Error al subir archivo');
  } finally {
    if (loading) loading.style.display = 'none';
    btn.disabled = false;
    btn.style.opacity = '';
    fileInputEl.value = '';
  }
};
document.getElementById('saveConfig').onclick = async () => {
  const apiInput = document.getElementById('apiKey');
  const key = apiInput.style.display === 'none' ? '' : apiInput.value.trim();
  const model = document.getElementById('modelSelect').value;
  const payload = {};
  if(key) payload.api_key = key;
  payload.model = model;
  const data = await fetchJson('/setconfig', {method:'POST', body: JSON.stringify(payload)});
  if(data.error){ toast.error('Error: '+data.error); } else {
    toast.success('Configuraci√≥n guardada');
    // hide API key input if user entered one
    if(key){
      apiInput.value = '';
      apiInput.style.display = 'none';
      document.getElementById('toggleApiKey').style.display = 'inline-block';
    }
  }
};
const promptDrawer = document.getElementById('promptDrawer');
const promptInput = document.getElementById('customPrompt');
const sendPromptBtn = document.getElementById('sendPrompt');
sendPromptBtn.setAttribute('aria-expanded', 'false');
sendPromptBtn.onclick = async () => {
  if (promptDrawer.classList.contains('hidden')) {
    promptDrawer.classList.remove('hidden');
    sendPromptBtn.setAttribute('aria-expanded', 'true');
    promptInput.focus();
    return;
  }
  const prompt = promptInput.value.trim();
  if(!prompt){ toast.info('Escribe una consulta'); return; }
  const context = 'global'; // Hook: supply selection/page context when API supports it
  const data = await fetchJson('/custom_gpt', {method:'POST', body: JSON.stringify({prompt: prompt /*, context */})});
  const history = document.getElementById('history');
  const details = document.createElement('details');
  const summary = document.createElement('summary');
  const shortPrompt = prompt.length > 40 ? prompt.substring(0,37) + '...' : prompt;
  summary.textContent = shortPrompt;
  const pre = document.createElement('pre');
  pre.textContent = data.response || data.error;
  details.appendChild(summary);
  details.appendChild(pre);
  history.prepend(details);
};
document.getElementById('closePrompt').onclick = () => {
  promptDrawer.classList.add('hidden');
  sendPromptBtn.setAttribute('aria-expanded', 'false');
};
document.getElementById('darkToggle').onclick = () => {
  document.body.classList.toggle('dark');
};

// Helper to parse dates from various formats (YYYY-MM-DD or other)
function parseDate(value) {
  if (!value) return null;
  // Try direct Date parse
  const d = new Date(value);
  if (!isNaN(d)) return d;
  // Try splitting by non-digit
  const parts = String(value).match(/(\d{4})[\/-]?(\d{2})[\/-]?(\d{2})/);
  if (parts) {
    const y = parseInt(parts[1]);
    const m = parseInt(parts[2]) - 1;
    const day = parseInt(parts[3]);
    return new Date(y, m, day);
  }
  return null;
}


// toggle API key visibility
document.getElementById('toggleApiKey').onclick = () => {
  const apiInput = document.getElementById('apiKey');
  apiInput.style.display = 'inline-block';
  document.getElementById('toggleApiKey').style.display = 'none';
};

// Show overlay with larger image
function showOverlay(src){
  const overlay = document.getElementById('imgOverlay');
  const img = document.getElementById('overlayImg');
  img.src = src;
  overlay.style.display = 'flex';
}
// Hide overlay only when clicking outside the image
document.getElementById('imgOverlay').onclick = (e) => {
  if (e.target.id === 'imgOverlay') {
    document.getElementById('imgOverlay').style.display = 'none';
  }
};

// Delete a single product by ID
async function deleteProduct(id){
  try {
    if (typeof currentListId !== 'undefined' && currentListId > 0) {
      // remove only from current list
      const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentListId, ids: [id]})});
      if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); }
      // reload current list
      loadList(currentListId);
    } else {
      const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: [id]})});
      if(data.error){ toast.error('Error al eliminar: '+data.error); }
      fetchProducts();
    }
  } catch(err){ console.error(err); toast.error('Error al eliminar'); }
}

// Delete selected products
document.getElementById('btnDelete').onclick = () => {
  const ids = Array.from(selection, Number);
  if(!ids.length){ toast.info('Selecciona al menos un producto para eliminar'); return; }
  toast.info('¬øEliminar los productos seleccionados?', {actionText:'Eliminar', onAction: async () => {
    try{
      if (typeof currentListId !== 'undefined' && currentListId > 0) {
        const data = await fetchJson('/remove_from_list', {method:'POST', body: JSON.stringify({list_id: currentListId, ids: ids})});
        if(data.error){ toast.error('Error al eliminar del grupo: '+data.error); } else { toast.success('Eliminados del grupo: '+data.removed); }
        startProgress();
        loadList(currentListId);
      } else {
        const data = await fetchJson('/delete', {method:'POST', body: JSON.stringify({ids: ids})});
        if(data.error){ toast.error('Error al eliminar: '+data.error); } else { toast.success('Productos eliminados: '+data.deleted); }
        startProgress();
        fetchProducts();
      }
    }catch(err){ console.error(err); toast.error('Error al eliminar'); }
  }});
};

// Export selected products as CSV
document.getElementById('btnExport').onclick = async () => {
  const ids = Array.from(selection, Number);
  if(!ids.length){ toast.info('Selecciona productos para exportar'); return; }
  // Build query string
  const params = new URLSearchParams();
  params.set('ids', ids.join(','));
  // request export file
  try{
    const res = await fetch('/export?'+params.toString(), {method:'GET'});
    if(res.status !== 200){ toast.error('Error al exportar'); return; }
    const blob = await res.blob();
    // determine filename from header or default
    const disposition = res.headers.get('Content-Disposition');
    let filename = 'export.csv';
    if(disposition){
      const match = disposition.match(/filename="?([^\"]+)"?/);
      if(match) filename = match[1];
    }
    // progress feedback
    startProgress();
    // trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch(err){ console.error(err); toast.error('Error al exportar'); }
};

// -------- List management --------
let currentListId = -1; // -1 indicates all products

async function loadLists() {
  try {
    const lists = await fetchJson('/lists');
    const container = document.getElementById('listsContainer');
    const select = document.getElementById('groupSelect');
    container.innerHTML = '';
    select.innerHTML = '';
    // option for no list in assign select
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Selecciona grupo';
    select.appendChild(placeholder);
    // Add a button to view all products
    const allBtn = document.createElement('button');
    allBtn.textContent = 'Todos';
    allBtn.style.padding = '4px 8px';
    allBtn.style.borderRadius = '4px';
    allBtn.style.border = '1px solid #34456B';
    allBtn.style.background = '#1F2A44';
    allBtn.style.color = '#E5EAF5';
    allBtn.style.cursor = 'pointer';
    allBtn.onclick = () => {
      currentListId = -1;
      loadList(-1);
    };
    const allWrapper = document.createElement('span');
    allWrapper.appendChild(allBtn);
    container.appendChild(allWrapper);

    // Add each list
    lists.forEach(lst => {
      // entry in container
      const btn = document.createElement('button');
      btn.textContent = lst.name;
      btn.style.padding = '4px 8px';
      btn.style.borderRadius = '4px';
      btn.style.border = '1px solid #34456B';
      btn.style.background = currentListId === lst.id ? '#33467B' : '#1F2A44';
      btn.style.color = currentListId === lst.id ? '#FFFFFF' : '#E5EAF5';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        currentListId = lst.id;
        loadList(lst.id);
      };
      // delete icon
      const del = document.createElement('span');
      del.textContent = ' ‚úñ';
      del.style.marginLeft = '4px';
      del.style.color = 'red';
      del.style.cursor = 'pointer';
      del.onclick = (ev) => {
        ev.stopPropagation();
        toast.info('¬øEliminar grupo?', {actionText:'Eliminar', onAction: () => deleteList(lst.id)});
      };
      const wrapper = document.createElement('span');
      wrapper.appendChild(btn);
      wrapper.appendChild(del);
      container.appendChild(wrapper);
      // option in select
      const opt = document.createElement('option');
      opt.value = lst.id;
      opt.textContent = lst.name;
      select.appendChild(opt);
    });
  } catch(err) {
    console.error(err);
  }
}

async function deleteList(id){
  try{
    const data = await fetchJson('/delete_list', {method:'POST', body: JSON.stringify({id:id})});
    loadLists();
    if(currentListId === id){
      currentListId = -1;
      fetchProducts();
    }
  }catch(err){ console.error(err); toast.error('Error al eliminar grupo'); }
}

async function loadList(id){
  if(id === -1){
    // load all products
    currentListId = -1;
    fetchProducts();
    // refresh lists to update active styling
    loadLists();
    return;
  }
  try{
    const data = await fetchJson('/list/' + id);
    allProducts = data;
    products = [...allProducts];
    window.allProducts = allProducts;
    window.products = products;
    selection.clear();
    updateMasterState();
    renderTable();
    // refresh lists to highlight active group
    loadLists();
  } catch(err){ console.error(err); toast.error('Error al cargar lista'); }
}

// create list button
document.getElementById('createListBtn').onclick = async () => {
  const name = document.getElementById('newListName').value.trim();
  if(!name){ toast.info('Ingresa un nombre para el grupo'); return; }
  try{
    const data = await fetchJson('/create_list', {method:'POST', body: JSON.stringify({name:name})});
    document.getElementById('newListName').value = '';
    loadLists();
  }catch(err){ console.error(err); toast.error('Error al crear grupo'); }
};

// assign selected products to list
document.getElementById('btnAddToGroup').onclick = async () => {
  const listSelect = document.getElementById('groupSelect');
  const lid = parseInt(listSelect.value);
  if(!lid){ toast.info('Selecciona un grupo'); return; }
  const ids = Array.from(selection, Number);
  if(!ids.length){ toast.info('Selecciona productos para a√±adir'); return; }
  try{
    const data = await fetchJson('/add_to_list', {method:'POST', body: JSON.stringify({id: lid, ids: ids})});
    toast.success('Productos a√±adidos al grupo');
    loadLists();
  }catch(err){ console.error(err); toast.error('Error al a√±adir al grupo'); }
};

// load lists on page load
window.addEventListener('DOMContentLoaded', () => {
  loadLists();
});

// trends button & analytics rendering
let trendsData = null;
let currentMetric = 'revenue';
document.getElementById('trendsBtn').onclick = async () => {
  const cont = document.getElementById('trends');
  if (cont.style.display === 'block') {
    cont.style.display = 'none';
    cont.innerHTML = '';
    document.getElementById('chartContainer').style.display = 'none';
    return;
  }
  cont.style.display = 'block';
  cont.innerHTML = '<h3>Tendencias</h3>';
  await loadTrends();
};
document.getElementById('applyTrendFilters').onclick = () => loadTrends();
document.getElementById('metricSelect').onchange = e => {
  currentMetric = e.target.value;
  renderTrends();
};

async function loadTrends(){
  const cont = document.getElementById('trends');
  const start = document.getElementById('trendStart').value;
  const end = document.getElementById('trendEnd').value;
  let url = '/trends';
  const params=[];
  if(start) params.push('start='+encodeURIComponent(start));
  if(end) params.push('end='+encodeURIComponent(end));
  if(params.length) url += '?' + params.join('&');
  const data = await fetchJson(url);
  if(data.error){ cont.textContent = 'Error al cargar tendencias: '+data.error; return; }
  trendsData = data;
  trendingWords = (data.keywords || []).map(([w])=>w.toLowerCase());
  let html = '<h3>Tendencias</h3>';
  if(data.top_products && data.top_products.length){
    html += '<strong>Top productos por Winner Score:</strong><ol>';
      data.top_products.forEach(item=>{ html += `<li>${item.name} (Winner Score: ${item.winner_score_v2_pct.toFixed(2)})</li>`; });
    html += '</ol>';
  }
  cont.innerHTML = html;
  renderTrends();
}

function renderTrends(){
  if(!trendsData) return;
  const chartDiv = document.getElementById('chartContainer');
  chartDiv.style.display='block';
  const k = trendsData.kpis || {};
  document.getElementById('kpiPanel').innerHTML = `
    <div><strong>Ingresos totales:</strong> ${k.total_revenue ? k.total_revenue.toFixed(2) : 0}</div>
    <div><strong>Unidades totales:</strong> ${k.total_units || 0}</div>
    <div><strong>Precio medio:</strong> ${k.avg_price ? k.avg_price.toFixed(2) : 0}</div>
    <div><strong>Categor√≠a top:</strong> ${k.top_category || '-'}</div>
    <div><strong>Producto top:</strong> ${k.top_product || '-'}</div>`;
  const tooltip = document.getElementById('chartTooltip');
  const drawHorizontal = (canvasId, entries, color, axisLabel) => {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const padL=120,padT=20,padB=40,barH=28,gap=12;
    const width = chartDiv.clientWidth - 40;
    canvas.width = width;
    canvas.height = padT + padB + entries.length*(barH+gap);
    ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const maxVal = Math.max(...entries.map(e=>e.value),0);
    ctx.font='14px sans-serif'; ctx.textBaseline='middle';
    const rects=[];
    entries.forEach((e,i)=>{
      const y=padT+i*(barH+gap);
      const len=maxVal?(e.value/maxVal)*(canvas.width-padL-40):0;
      ctx.fillStyle=color; ctx.fillRect(padL,y,len,barH);
      ctx.fillStyle='#000'; ctx.fillText(e.value,padL+len+5,y+barH/2);
      ctx.fillText(e.label,10,y+barH/2);
      rects.push({x:padL,y:y,w:len,h:barH,data:e});
    });
    ctx.strokeStyle='#666'; ctx.beginPath();
    ctx.moveTo(padL,padT-10); ctx.lineTo(padL,canvas.height-padB); ctx.lineTo(canvas.width-20,canvas.height-padB); ctx.stroke();
    ctx.font='16px sans-serif'; ctx.fillStyle='#000'; if(axisLabel) ctx.fillText(axisLabel,canvas.width/2,canvas.height-10);
    canvas.onmousemove=ev=>{
      const r=canvas.getBoundingClientRect(); const mx=ev.clientX-r.left,my=ev.clientY-r.top;
      const hit=rects.find(b=>mx>=b.x && mx<=b.x+b.w && my>=b.y && my<=b.y+b.h);
      if(hit){ tooltip.style.display='block'; tooltip.textContent=hit.data.tooltip||`${hit.data.label}: ${hit.data.value}`; tooltip.style.left=ev.pageX+10+'px'; tooltip.style.top=ev.pageY+10+'px'; }
      else tooltip.style.display='none'; };
    canvas.onmouseleave=()=>tooltip.style.display='none';
  };
  const drawScatter = (canvasId, points, color, xLabel, yLabel) => {
    const canvas=document.getElementById(canvasId); const ctx=canvas.getContext('2d');
    const padL=60,padB=40,padT=20,width=chartDiv.clientWidth-40,height=400;
    canvas.width=width; canvas.height=height;
    ctx.fillStyle='#fafafa'; ctx.fillRect(0,0,width,height);
    const maxX=Math.max(...points.map(p=>p.x),0), maxY=Math.max(...points.map(p=>p.y),0), maxR=Math.max(...points.map(p=>p.r||0),0);
    const pts=[];
    points.forEach(p=>{ const x=padL+(maxX?(p.x/maxX)*(width-padL-20):0); const y=height-padB-(maxY?(p.y/maxY)*(height-padT-padB):0); const r=p.r?Math.max(4,(p.r/maxR)*20):6; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); pts.push({x,y,r,data:p});});
    ctx.strokeStyle='#666'; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,height-padB); ctx.lineTo(width-20,height-padB); ctx.stroke();
    ctx.font='16px sans-serif'; ctx.fillStyle='#000'; ctx.fillText(xLabel,width/2,height-10); ctx.save(); ctx.translate(20,height/2); ctx.rotate(-Math.PI/2); ctx.fillText(yLabel,0,0); ctx.restore();
    canvas.onmousemove=ev=>{ const r=canvas.getBoundingClientRect(); const mx=ev.clientX-r.left,my=ev.clientY-r.top; const hit=pts.find(p=>Math.hypot(mx-p.x,my-p.y)<=p.r); if(hit){ const d=hit.data; tooltip.style.display='block'; tooltip.innerHTML=`${d.label||''}<br/>Ingresos: ${d.revenue?.toFixed?d.revenue.toFixed(2):d.y.toFixed(2)}<br/>Unidades: ${d.units||''}<br/>Rating: ${d.rating||''}`; tooltip.style.left=ev.pageX+10+'px'; tooltip.style.top=ev.pageY+10+'px'; } else tooltip.style.display='none'; };
    canvas.onmouseleave=()=>tooltip.style.display='none';
  };
  const metricLabel = currentMetric==='units'?'Unidades medias':currentMetric==='avg_price'?'Precio medio':'Ingresos medios';
  const catPts=(trendsData.category_compare||[]).map(c=>({x:c.products,y:currentMetric==='units'?c.avg_units:currentMetric==='avg_price'?c.avg_price:c.avg_revenue,label:c.category,revenue:c.total_revenue,units:c.total_units,rating:c.avg_rating}));
  drawScatter('catCompareCanvas',catPts,'#26a69a','Productos listados',metricLabel);
  renderCategorySummary();
  drawHorizontal('catRevenueGrowthCanvas',(trendsData.cat_revenue_growth||[]).map(e=>({label:e[0],value:e[1]})),'#42a5f5','Crecimiento ingresos');
  drawHorizontal('catUnitGrowthCanvas',(trendsData.cat_units_growth||[]).map(e=>({label:e[0],value:e[1]})),'#66bb6a','Crecimiento unidades');
  drawHorizontal('catRevPerUnitCanvas',(trendsData.cat_rev_per_unit||[]).map(e=>({label:e[0],value:e[1]})),'#ffca28','Ingresos/unidad');
  drawHorizontal('keywordTrendCanvas',(trendsData.keywords||[]).map(e=>({label:e[0],value:e[1]})),'#29b6f6','Frecuencia');
  drawHorizontal('brandTrendCanvas',(trendsData.brands||[]).map(e=>({label:e[0],value:e[1]})),'#ab47bc','Frecuencia');
  drawScatter('ratingRevenueCanvas',trendsData.scatter_rating_revenue||[],'#ef5350','Rating','Ingresos');
  drawScatter('priceRevenueCanvas',trendsData.scatter_price_revenue||[],'#7e57c2','Precio promedio','Ingresos');
  renderTable();
}

let catSort={key:'category',asc:true};
function renderCategorySummary(){
  const table=document.getElementById('categorySummaryTable');
  if(!table) return;
  let rows=[...(trendsData.category_summary||[])];
  rows.sort((a,b)=>{const k=catSort.key;const va=a[k],vb=b[k];if(typeof va==='string') return catSort.asc?va.localeCompare(vb):vb.localeCompare(va);return catSort.asc?va-vb:vb-va;});
  let head=`<thead><tr><th data-key="category">Categor√≠a</th><th data-key="products">#Productos</th><th data-key="total_units">Unidades totales</th><th data-key="total_revenue">Ingresos totales</th><th data-key="avg_price">Precio promedio</th><th data-key="avg_rating">Rating promedio</th></tr></thead>`;
  let body='<tbody>';
  rows.forEach(r=>{body+=`<tr><td>${r.category}</td><td>${r.products}</td><td>${r.total_units.toFixed(0)}</td><td>${r.total_revenue.toFixed(2)}</td><td>${r.avg_price.toFixed(2)}</td><td>${r.avg_rating.toFixed(2)}</td></tr>`;});
  body+='</tbody>'; table.innerHTML=head+body;
  table.querySelectorAll('th').forEach(th=>{th.style.cursor='pointer';th.onclick=()=>{const key=th.dataset.key;if(catSort.key===key) catSort.asc=!catSort.asc; else {catSort.key=key;catSort.asc=true;} renderCategorySummary();};});
}

window.renderTable = renderTable;
window.startProgress = startProgress;
window.parseDate = parseDate;
</script>
<div id="chartTooltip" style="position:absolute; background:#fff; border:1px solid #333; padding:4px; font-size:12px; border-radius:4px; pointer-events:none; display:none; z-index:2000;"></div>
<script src="/static/js/filters.js"></script>
</body>
</html>
