#!/usr/bin/env bash
set -Eeuo pipefail

# ==== Resolve project root ====
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

LOG_DIR="$SCRIPT_DIR/logs"
mkdir -p "$LOG_DIR"

# ==== Python selection ====
PYTHON_BIN="${PYTHON_BIN:-python3}"

# ==== Venv bootstrap only once ====
if [[ ! -d ".venv" ]]; then
  "$PYTHON_BIN" -m venv ".venv"
  BOOTSTRAP=1
else
  BOOTSTRAP=0
fi

# shellcheck source=/dev/null
source ".venv/bin/activate"

# ==== Install deps only on first run or when requirements.txt changes ====
REQ_FILE="requirements.txt"
HASH_FILE=".venv/.req.sha256"

calc_hash() { shasum -a 256 "$REQ_FILE" | awk '{print $1}'; }

if [[ "$BOOTSTRAP" -eq 1 || ! -f "$HASH_FILE" || "$(calc_hash)" != "$(cat "$HASH_FILE" 2>/dev/null || true)" ]]; then
  python -m pip install --upgrade pip
  pip install -r "$REQ_FILE"
  calc_hash > "$HASH_FILE"
fi

# ==== Run app ====
export PYTHONUNBUFFERED=1
# Abre el navegador en segundo plano tras breve delay
( sleep 2; open -g "http://127.0.0.1:8000" ) >/dev/null 2>&1 &

# Lanza la app y tee al log
python -u -m product_research_app 2>&1 | tee "$LOG_DIR/session.log"
